AWSTemplateFormatVersion: "2010-09-09"

Description: |
  HEAT template for creating Windows server on  Rackspace Cloud

Parameters:

  name:
    Default: HeatTestResource
    Description: Windows Server Name
    Type: String
    MinLength: 1
    MaxLength: 64
    AllowedPattern: "[a-zA-Z][a-zA-Z0-9]*"
    ConstraintDescription: must begin with a letter and contain only alphanumeric characters.

  image:
    Description : Windows Server Image
    Type: String
    Default: Windows Server 2012 (with updates)

  memory: 
    Description : Windows Server memory(RAM) in MB
    Type: Number
    Default: 2048


Resources:

  RSWindowsServer:
    Type: "Rackspace::Cloud::CloudWinServer"
    Properties:
      name:
        Ref: name
      memory:
        Ref: memory
      image:
        Ref: image
      user_data: { "Fn::Base64" : { "Fn::Join" : ["", [
                  '$source = "http://download.microsoft.com/download/7/0/4/704CEB4C-9F42-4962-A2B0-5C84B0682C7A/WebPlatformInstaller_amd64_en-US.msi"\n',
                  '$destination = "webpi.msi"\n',
                  '$wc = New-Object System.Net.WebClient\n',
                  '$wc.DownloadFile($source, $destination)\n',
                  'Start-Process msiexec -ArgumentList "/i webpi.msi /qn"  -NoNewWindow -Wait\n',
                  'echo "DbPassword[@]verybadpass_123" "DbAdminPassword[@]verybadpass_123" > test.app\n',
                  '$tmpprofile = $env:userprofile\n',
                  '$env:userprofile = "c:\users\administrator"\n',
                  'Start-Process "C:\Program Files\Microsoft\Web Platform Installer\WebPICMD.exe"  -ArgumentList "/Install /Application:Wordpress@test.app /MySQLPassword:verybadpass_123 /AcceptEULA /Log:.\\wpi.log"  -NoNewWindow -Wait\n',
                  '$env:userprofile = $tmpprofile\n'
              ]]}}
Outputs:

  PublicIp:
    Value: { "Fn::GetAtt" : [ "RSWindowsServer", "PublicIp" ] }
    Description: public IP of the windows server
  
  WebsiteURL:
    Value: { "Fn::Join" : ["", ["http://", { "Fn::GetAtt" : [ "RSWindowsServer", "PublicIp" ]}, "/wordpress"]] }
    Description: URL for Wordpress wiki



<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>heat.engine.service &mdash; Supported Resources</title>
    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2015.2.0.dev378',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Supported Resources" href="../../../raxdox/index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../../../raxdox/index.html">Supported Resources</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for heat.engine.service</h1><div class="highlight"><pre>
<span class="c">#</span>
<span class="c">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c">#    a copy of the License at</span>
<span class="c">#</span>
<span class="c">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c">#    License for the specific language governing permissions and limitations</span>
<span class="c">#    under the License.</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">eventlet</span>
<span class="kn">from</span> <span class="nn">oslo_config</span> <span class="kn">import</span> <span class="n">cfg</span>
<span class="kn">from</span> <span class="nn">oslo_log</span> <span class="kn">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">logging</span>
<span class="kn">import</span> <span class="nn">oslo_messaging</span> <span class="kn">as</span> <span class="nn">messaging</span>
<span class="kn">from</span> <span class="nn">oslo_serialization</span> <span class="kn">import</span> <span class="n">jsonutils</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">uuidutils</span>
<span class="kn">from</span> <span class="nn">osprofiler</span> <span class="kn">import</span> <span class="n">profiler</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">webob</span>

<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">exception</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LE</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LI</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LW</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">identifier</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">messaging</span> <span class="k">as</span> <span class="n">rpc_messaging</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">service_utils</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">template_format</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">api</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">attributes</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">clients</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">environment</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">event</span> <span class="k">as</span> <span class="n">evt</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">parameter_groups</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">properties</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">service_software_config</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">service_stack_watch</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">stack</span> <span class="k">as</span> <span class="n">parser</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">stack_lock</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">template</span> <span class="k">as</span> <span class="n">templatem</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">watchrule</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">worker</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">event</span> <span class="k">as</span> <span class="n">event_object</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">resource</span> <span class="k">as</span> <span class="n">resource_objects</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">service</span> <span class="k">as</span> <span class="n">service_objects</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">snapshot</span> <span class="k">as</span> <span class="n">snapshot_object</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">stack</span> <span class="k">as</span> <span class="n">stack_object</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">watch_data</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">watch_rule</span>
<span class="kn">from</span> <span class="nn">heat.openstack.common</span> <span class="kn">import</span> <span class="n">service</span>
<span class="kn">from</span> <span class="nn">heat.openstack.common</span> <span class="kn">import</span> <span class="n">threadgroup</span>
<span class="kn">from</span> <span class="nn">heat.rpc</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">rpc_api</span>
<span class="kn">from</span> <span class="nn">heat.rpc</span> <span class="kn">import</span> <span class="n">worker_api</span> <span class="k">as</span> <span class="n">rpc_worker_api</span>

<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s">&#39;engine_life_check_timeout&#39;</span><span class="p">,</span> <span class="s">&#39;heat.common.config&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s">&#39;max_resources_per_stack&#39;</span><span class="p">,</span> <span class="s">&#39;heat.common.config&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s">&#39;max_stacks_per_tenant&#39;</span><span class="p">,</span> <span class="s">&#39;heat.common.config&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s">&#39;enable_stack_abandon&#39;</span><span class="p">,</span> <span class="s">&#39;heat.common.config&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s">&#39;enable_stack_adopt&#39;</span><span class="p">,</span> <span class="s">&#39;heat.common.config&#39;</span><span class="p">)</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s">&#39;convergence_engine&#39;</span><span class="p">,</span> <span class="s">&#39;heat.common.config&#39;</span><span class="p">)</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ThreadGroupManager"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.ThreadGroupManager">[docs]</a><span class="k">class</span> <span class="nc">ThreadGroupManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ThreadGroupManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="c"># Create dummy service task, because when there is nothing queued</span>
        <span class="c"># on self.tg the process exits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">periodic_interval</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service_task</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_service_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a dummy task which gets queued on the service.Service</span>
<span class="sd">        threadgroup.  Without this service.Service sees nothing running</span>
<span class="sd">        i.e has nothing to wait() on, so the process exits..</span>
<span class="sd">        This could also be used to trigger periodic non-stack-specific</span>
<span class="sd">        housekeeping tasks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_serialize_profile_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prof</span> <span class="o">=</span> <span class="n">profiler</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">trace_info</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">prof</span><span class="p">:</span>
            <span class="n">trace_info</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&quot;hmac_key&quot;</span><span class="p">:</span> <span class="n">prof</span><span class="o">.</span><span class="n">hmac_key</span><span class="p">,</span>
                <span class="s">&quot;base_id&quot;</span><span class="p">:</span> <span class="n">prof</span><span class="o">.</span><span class="n">get_base_id</span><span class="p">(),</span>
                <span class="s">&quot;parent_id&quot;</span><span class="p">:</span> <span class="n">prof</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">trace_info</span>

    <span class="k">def</span> <span class="nf">_start_with_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">trace</span><span class="p">:</span>
            <span class="n">profiler</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="o">**</span><span class="n">trace</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ThreadGroupManager.start"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.ThreadGroupManager.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the given method in a sub-thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">threadgroup</span><span class="o">.</span><span class="n">ThreadGroup</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_start_with_trace</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_profile_info</span><span class="p">(),</span>
                                                <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadGroupManager.start_with_lock"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.ThreadGroupManager.start_with_lock">[docs]</a>    <span class="k">def</span> <span class="nf">start_with_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Try to acquire a stack lock and, if successful, run the given</span>
<span class="sd">        method in a sub-thread.  Release the lock when the thread</span>
<span class="sd">        finishes.</span>

<span class="sd">        :param cnxt: RPC context</span>
<span class="sd">        :param stack: Stack to be operated on</span>
<span class="sd">        :type stack: heat.engine.parser.Stack</span>
<span class="sd">        :param engine_id: The UUID of the engine/worker acquiring the lock</span>
<span class="sd">        :param func: Callable to be invoked in sub-thread</span>
<span class="sd">        :type func: function or instancemethod</span>
<span class="sd">        :param args: Args to be passed to func</span>
<span class="sd">        :param kwargs: Keyword-args to be passed to func.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">lock</span><span class="o">.</span><span class="n">thread_lock</span><span class="p">():</span>
            <span class="n">th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_with_acquired_lock</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span>
                                               <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">th</span>
</div>
<div class="viewcode-block" id="ThreadGroupManager.start_with_acquired_lock"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.ThreadGroupManager.start_with_acquired_lock">[docs]</a>    <span class="k">def</span> <span class="nf">start_with_acquired_lock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the given method in a sub-thread and release the provided lock</span>
<span class="sd">        when the thread finishes.</span>

<span class="sd">        :param stack: Stack to be operated on</span>
<span class="sd">        :type stack: heat.engine.parser.Stack</span>
<span class="sd">        :param lock: The acquired stack lock</span>
<span class="sd">        :type lock: heat.engine.stack_lock.StackLock</span>
<span class="sd">        :param func: Callable to be invoked in sub-thread</span>
<span class="sd">        :type func: function or instancemethod</span>
<span class="sd">        :param args: Args to be passed to func</span>
<span class="sd">        :param kwargs: Keyword-args to be passed to func</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="n">gt</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Callback function that will be passed to GreenThread.link().</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="n">th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">release</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">th</span>
</div>
<div class="viewcode-block" id="ThreadGroupManager.add_timer"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.ThreadGroupManager.add_timer">[docs]</a>    <span class="k">def</span> <span class="nf">add_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Define a periodic task, to be run in a separate thread, in the stack</span>
<span class="sd">        threadgroups.  Periodicity is cfg.CONF.periodic_interval</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">threadgroup</span><span class="o">.</span><span class="n">ThreadGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">periodic_interval</span><span class="p">,</span>
                                        <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadGroupManager.add_event"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.ThreadGroupManager.add_event">[docs]</a>    <span class="k">def</span> <span class="nf">add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadGroupManager.remove_event"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.ThreadGroupManager.remove_event">[docs]</a>    <span class="k">def</span> <span class="nf">remove_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gt</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">stack_id</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">event</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">stack_id</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ThreadGroupManager.stop_timers"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.ThreadGroupManager.stop_timers">[docs]</a>    <span class="k">def</span> <span class="nf">stop_timers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span><span class="o">.</span><span class="n">stop_timers</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ThreadGroupManager.stop"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.ThreadGroupManager.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">,</span> <span class="n">graceful</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Stop any active threads on a stack.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">stack_id</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">threadgroup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">stack_id</span><span class="p">)</span>
            <span class="n">threads</span> <span class="o">=</span> <span class="n">threadgroup</span><span class="o">.</span><span class="n">threads</span><span class="p">[:]</span>

            <span class="n">threadgroup</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">graceful</span><span class="p">)</span>
            <span class="n">threadgroup</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="c"># Wait for link()ed functions (i.e. lock release)</span>
            <span class="n">links_done</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">th</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">mark_done</span><span class="p">(</span><span class="n">gt</span><span class="p">,</span> <span class="n">th</span><span class="p">):</span>
                <span class="n">links_done</span><span class="p">[</span><span class="n">th</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="n">th</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="n">mark_done</span><span class="p">,</span> <span class="n">th</span><span class="p">)</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">links_done</span><span class="p">)):</span>
                <span class="n">eventlet</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="ThreadGroupManager.send"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.ThreadGroupManager.send">[docs]</a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">stack_id</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">event</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

</div></div>
<span class="nd">@profiler.trace_cls</span><span class="p">(</span><span class="s">&quot;rpc&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="EngineListener"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineListener">[docs]</a><span class="k">class</span> <span class="nc">EngineListener</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Listen on an AMQP queue named for the engine.  Allows individual</span>
<span class="sd">    engines to communicate with each other for multi-engine support.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">ACTIONS</span> <span class="o">=</span> <span class="p">(</span><span class="n">STOP_STACK</span><span class="p">,</span> <span class="n">SEND</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;stop_stack&#39;</span><span class="p">,</span> <span class="s">&#39;send&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span> <span class="n">thread_group_mgr</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EngineListener</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="o">=</span> <span class="n">thread_group_mgr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span> <span class="o">=</span> <span class="n">engine_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>

<div class="viewcode-block" id="EngineListener.start"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineListener.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EngineListener</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">messaging</span><span class="o">.</span><span class="n">Target</span><span class="p">(</span>
            <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
            <span class="n">topic</span><span class="o">=</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">LISTENER_TOPIC</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="n">rpc_messaging</span><span class="o">.</span><span class="n">get_rpc_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="EngineListener.listening"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineListener.listening">[docs]</a>    <span class="k">def</span> <span class="nf">listening</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Respond affirmatively to confirm that the engine performing the</span>
<span class="sd">        action is still alive.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="EngineListener.stop_stack"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineListener.stop_stack">[docs]</a>    <span class="k">def</span> <span class="nf">stop_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Stop any active threads on a stack.&#39;&#39;&#39;</span>
        <span class="n">stack_id</span> <span class="o">=</span> <span class="n">stack_identity</span><span class="p">[</span><span class="s">&#39;stack_id&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">stack_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EngineListener.send"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineListener.send">[docs]</a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="n">stack_id</span> <span class="o">=</span> <span class="n">stack_identity</span><span class="p">[</span><span class="s">&#39;stack_id&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">stack_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

</div></div>
<span class="nd">@profiler.trace_cls</span><span class="p">(</span><span class="s">&quot;rpc&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="EngineService"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService">[docs]</a><span class="k">class</span> <span class="nc">EngineService</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manages the running instances from creation to destruction.</span>
<span class="sd">    All the methods in here are called from the RPC backend.  This is</span>
<span class="sd">    all done dynamically so if a call is made via RPC that does not</span>
<span class="sd">    have a corresponding method here, an exception will be thrown when</span>
<span class="sd">    it attempts to call into this class.  Arguments to these methods</span>
<span class="sd">    are also dynamically added and will be named as keyword arguments</span>
<span class="sd">    by the RPC caller.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">RPC_API_VERSION</span> <span class="o">=</span> <span class="s">&#39;1.9&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EngineService</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="n">resources</span><span class="o">.</span><span class="n">initialise</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">topic</span> <span class="o">=</span> <span class="n">topic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="s">&#39;heat-engine&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>

        <span class="c"># The following are initialized here, but assigned in start() which</span>
        <span class="c"># happens after the fork when spawning multiple worker processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack_watch</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_service</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span> <span class="o">=</span> <span class="n">service_software_config</span><span class="o">.</span><span class="n">SoftwareConfigService</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">instance_user</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;The &quot;instance_user&quot; option in heat.conf is &#39;</span>
                          <span class="s">&#39;deprecated and will be removed in the Juno &#39;</span>
                          <span class="s">&#39;release.&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">trusts_delegated_roles</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;The default value of &quot;trusts_delegated_roles&quot; &#39;</span>
                          <span class="s">&#39;option in heat.conf is changed to [] in Kilo &#39;</span>
                          <span class="s">&#39;and heat will delegate all roles of trustor. &#39;</span>
                          <span class="s">&#39;Please keep the same if you do not want to &#39;</span>
                          <span class="s">&#39;delegate subset roles when upgrading.&#39;</span><span class="p">,</span>
                          <span class="ne">Warning</span><span class="p">)</span>

<div class="viewcode-block" id="EngineService.create_periodic_tasks"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.create_periodic_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">create_periodic_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Starting periodic watch tasks pid=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
        <span class="c"># Note with multiple workers, the parent process hasn&#39;t called start()</span>
        <span class="c"># so we need to create a ThreadGroupManager here for the periodic tasks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="o">=</span> <span class="n">ThreadGroupManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack_watch</span> <span class="o">=</span> <span class="n">service_stack_watch</span><span class="o">.</span><span class="n">StackWatch</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="p">)</span>

        <span class="c"># Create a periodic_watcher_task per-stack</span>
        <span class="n">admin_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_admin_context</span><span class="p">()</span>
        <span class="n">stacks</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span>
            <span class="n">admin_context</span><span class="p">,</span>
            <span class="n">tenant_safe</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">show_hidden</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack_watch</span><span class="o">.</span><span class="n">start_watch_task</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">admin_context</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EngineService.start"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="o">.</span><span class="n">generate_engine_id</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span> <span class="o">=</span> <span class="n">ThreadGroupManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener</span> <span class="o">=</span> <span class="n">EngineListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Starting listener for engine </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">convergence_engine</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker_service</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">WorkerService</span><span class="p">(</span>
                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                <span class="n">topic</span><span class="o">=</span><span class="n">rpc_worker_api</span><span class="o">.</span><span class="n">TOPIC</span><span class="p">,</span>
                <span class="n">engine_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                <span class="n">thread_group_mgr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker_service</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;WorkerService is started in engine </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>

        <span class="n">target</span> <span class="o">=</span> <span class="n">messaging</span><span class="o">.</span><span class="n">Target</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RPC_API_VERSION</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="n">topic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span> <span class="o">=</span> <span class="n">rpc_messaging</span><span class="o">.</span><span class="n">get_rpc_server</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">rpc_messaging</span><span class="o">.</span><span class="n">get_rpc_client</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RPC_API_VERSION</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service_manage_cleanup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span> <span class="o">=</span> <span class="n">threadgroup</span><span class="o">.</span><span class="n">ThreadGroup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span><span class="o">.</span><span class="n">add_timer</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">periodic_interval</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">service_manage_report</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span><span class="o">.</span><span class="n">add_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_stack_status</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">EngineService</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_stop_rpc_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Stop rpc connection at first for preventing new requests</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Attempting to stop engine service...&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_server</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&quot;Engine service is stopped successfully&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&quot;Failed to stop engine service, </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>

<div class="viewcode-block" id="EngineService.stop"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_rpc_server</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">convergence_engine</span><span class="p">:</span>
            <span class="c"># Stop the WorkerService</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">worker_service</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&quot;WorkerService is stopped in engine </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">),</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>

        <span class="c"># Wait for all active threads to be finished</span>
        <span class="k">for</span> <span class="n">stack_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="c"># Ignore dummy service task</span>
            <span class="k">if</span> <span class="n">stack_id</span> <span class="o">==</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">periodic_interval</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&quot;Waiting stack </span><span class="si">%s</span><span class="s"> processing to be finished&quot;</span><span class="p">),</span>
                     <span class="n">stack_id</span><span class="p">)</span>
            <span class="c"># Stop threads gracefully</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">stack_id</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&quot;Stack </span><span class="si">%s</span><span class="s"> processing was finished&quot;</span><span class="p">),</span> <span class="n">stack_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">manage_thread_grp</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="n">ctxt</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_admin_context</span><span class="p">()</span>
        <span class="n">service_objects</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">ctxt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Service </span><span class="si">%s</span><span class="s"> is deleted&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span><span class="p">)</span>

        <span class="c"># Terminate the engine process</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&quot;All threads were gone, terminating engine&quot;</span><span class="p">))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EngineService</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.identify_stack"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.identify_stack">[docs]</a>    <span class="k">def</span> <span class="nf">identify_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The identify_stack method returns the full stack identifier for a</span>
<span class="sd">        single, live stack given the stack name.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_name: Name or UUID of the stack to look up.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">is_uuid_like</span><span class="p">(</span><span class="n">stack_name</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span>
                <span class="n">stack_name</span><span class="p">,</span>
                <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c"># may be the name is in uuid format, so if get by id returns None,</span>
            <span class="c"># we should get the info by name again</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackNotFound</span><span class="p">(</span><span class="n">stack_name</span><span class="o">=</span><span class="n">stack_name</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_get_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">show_deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">identifier</span><span class="o">.</span><span class="n">HeatIdentifier</span><span class="p">(</span><span class="o">**</span><span class="n">stack_identity</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">identity</span><span class="o">.</span><span class="n">stack_id</span><span class="p">,</span>
            <span class="n">show_deleted</span><span class="o">=</span><span class="n">show_deleted</span><span class="p">,</span>
            <span class="n">eager_load</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackNotFound</span><span class="p">(</span><span class="n">stack_name</span><span class="o">=</span><span class="n">identity</span><span class="o">.</span><span class="n">stack_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cnxt</span><span class="o">.</span><span class="n">tenant_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">identity</span><span class="o">.</span><span class="n">tenant</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">stack_user_project_id</span><span class="p">):</span>
            <span class="c"># The DB API should not allow this, but sanity-check anyway..</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidTenant</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">identity</span><span class="o">.</span><span class="n">tenant</span><span class="p">,</span>
                                          <span class="n">actual</span><span class="o">=</span><span class="n">cnxt</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">identity</span><span class="o">.</span><span class="n">path</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">identity</span><span class="o">.</span><span class="n">stack_name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackNotFound</span><span class="p">(</span><span class="n">stack_name</span><span class="o">=</span><span class="n">identity</span><span class="o">.</span><span class="n">stack_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">s</span>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.show_stack"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.show_stack">[docs]</a>    <span class="k">def</span> <span class="nf">show_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return detailed information about one or all stacks.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to show, or None</span>
<span class="sd">            to show all</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stack_identity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">db_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">stacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">db_stack</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stacks</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="k">for</span> <span class="n">stack</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="EngineService.get_revision"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.get_revision">[docs]</a>    <span class="k">def</span> <span class="nf">get_revision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">revision</span><span class="p">[</span><span class="s">&#39;heat_revision&#39;</span><span class="p">]</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.list_stacks"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.list_stacks">[docs]</a>    <span class="k">def</span> <span class="nf">list_stacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">sort_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tenant_safe</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">show_deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_nested</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_hidden</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tags_any</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">not_tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">not_tags_any</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The list_stacks method returns attributes of all stacks.  It supports</span>
<span class="sd">        pagination (``limit`` and ``marker``), sorting (``sort_keys`` and</span>
<span class="sd">        ``sort_dir``) and filtering (``filters``) of the results.</span>

<span class="sd">        :param cnxt: RPC context</span>
<span class="sd">        :param limit: the number of stacks to list (integer or string)</span>
<span class="sd">        :param marker: the ID of the last item in the previous page</span>
<span class="sd">        :param sort_keys: an array of fields used to sort the list</span>
<span class="sd">        :param sort_dir: the direction of the sort (&#39;asc&#39; or &#39;desc&#39;)</span>
<span class="sd">        :param filters: a dict with attribute:value to filter the list</span>
<span class="sd">        :param tenant_safe: if true, scope the request by the current tenant</span>
<span class="sd">        :param show_deleted: if true, show soft-deleted stacks</span>
<span class="sd">        :param show_nested: if true, show nested stacks</span>
<span class="sd">        :param show_hidden: if true, show hidden stacks</span>
<span class="sd">        :param tags: show stacks containing these tags, combine multiple</span>
<span class="sd">            tags using the boolean AND expression</span>
<span class="sd">        :param tags_any: show stacks containing these tags, combine multiple</span>
<span class="sd">            tags using the boolean OR expression</span>
<span class="sd">        :param not_tags: show stacks not containing these tags, combine</span>
<span class="sd">            multiple tags using the boolean AND expression</span>
<span class="sd">        :param not_tags_any: show stacks not containing these tags, combine</span>
<span class="sd">            multiple tags using the boolean OR expression</span>
<span class="sd">        :returns: a list of formatted stacks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stacks</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="n">sort_keys</span><span class="p">,</span>
                                       <span class="n">sort_dir</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">tenant_safe</span><span class="p">,</span>
                                       <span class="n">show_deleted</span><span class="p">,</span> <span class="n">resolve_data</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                       <span class="n">show_nested</span><span class="o">=</span><span class="n">show_nested</span><span class="p">,</span>
                                       <span class="n">show_hidden</span><span class="o">=</span><span class="n">show_hidden</span><span class="p">,</span>
                                       <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span> <span class="n">tags_any</span><span class="o">=</span><span class="n">tags_any</span><span class="p">,</span>
                                       <span class="n">not_tags</span><span class="o">=</span><span class="n">not_tags</span><span class="p">,</span>
                                       <span class="n">not_tags_any</span><span class="o">=</span><span class="n">not_tags_any</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_stack</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="k">for</span> <span class="n">stack</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">]</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.count_stacks"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.count_stacks">[docs]</a>    <span class="k">def</span> <span class="nf">count_stacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tenant_safe</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">show_deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_nested</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_hidden</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tags_any</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">not_tags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">not_tags_any</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the number of stacks that match the given filters</span>
<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param filters: a dict of ATTR:VALUE to match against stacks</span>
<span class="sd">        :param tenant_safe: if true, scope the request by the current tenant</span>
<span class="sd">        :param show_deleted: if true, count will include the deleted stacks</span>
<span class="sd">        :param show_nested: if true, count will include nested stacks</span>
<span class="sd">        :param show_hidden: if true, count will include hidden stacks</span>
<span class="sd">        :param tags: count stacks containing these tags, combine multiple tags</span>
<span class="sd">            using the boolean AND expression</span>
<span class="sd">        :param tags_any: count stacks containing these tags, combine multiple</span>
<span class="sd">            tags using the boolean OR expression</span>
<span class="sd">        :param not_tags: count stacks not containing these tags, combine</span>
<span class="sd">            multiple tags using the boolean AND expression</span>
<span class="sd">        :param not_tags_any: count stacks not containing these tags, combine</span>
<span class="sd">            multiple tags using the boolean OR expression</span>
<span class="sd">        :returns: a integer representing the number of matched stacks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">count_all</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
            <span class="n">tenant_safe</span><span class="o">=</span><span class="n">tenant_safe</span><span class="p">,</span>
            <span class="n">show_deleted</span><span class="o">=</span><span class="n">show_deleted</span><span class="p">,</span>
            <span class="n">show_nested</span><span class="o">=</span><span class="n">show_nested</span><span class="p">,</span>
            <span class="n">show_hidden</span><span class="o">=</span><span class="n">show_hidden</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">,</span>
            <span class="n">tags_any</span><span class="o">=</span><span class="n">tags_any</span><span class="p">,</span>
            <span class="n">not_tags</span><span class="o">=</span><span class="n">not_tags</span><span class="p">,</span>
            <span class="n">not_tags_any</span><span class="o">=</span><span class="n">not_tags_any</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_validate_deferred_auth_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">deferred_auth_method</span> <span class="o">!=</span> <span class="s">&#39;password&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="o">.</span><span class="n">requires_deferred_auth</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">cnxt</span><span class="o">.</span><span class="n">username</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">MissingCredentialError</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="s">&#39;X-Auth-User&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cnxt</span><span class="o">.</span><span class="n">password</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">MissingCredentialError</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="s">&#39;X-Auth-Key&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_validate_new_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">parsed_template</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parsed_template</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_name</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackExists</span><span class="p">(</span><span class="n">stack_name</span><span class="o">=</span><span class="n">stack_name</span><span class="p">)</span>

        <span class="n">tenant_limit</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">max_stacks_per_tenant</span>
        <span class="k">if</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">count_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">tenant_limit</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;You have reached the maximum stacks per tenant, </span><span class="si">%d</span><span class="s">.&quot;</span>
                        <span class="s">&quot; Please delete some stacks.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">tenant_limit</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">RequestLimitExceeded</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>

        <span class="n">num_resources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parsed_template</span><span class="p">[</span><span class="n">parsed_template</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">num_resources</span> <span class="o">&gt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">max_resources_per_stack</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackResourceLimitExceeded</span><span class="o">.</span><span class="n">msg_fmt</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">RequestLimitExceeded</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_template_and_validate_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span>
                                           <span class="n">params</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                           <span class="n">nested_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">user_creds_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                           <span class="n">stack_user_project_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                           <span class="n">convergence</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                           <span class="n">parent_resource_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">common_params</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">extract_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="c"># If it is stack-adopt, use parameters from adopt_stack_data</span>
        <span class="k">if</span> <span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_ADOPT_STACK_DATA</span> <span class="ow">in</span> <span class="n">common_params</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">enable_stack_adopt</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="s">&#39;Stack Adopt&#39;</span><span class="p">)</span>

            <span class="c"># Override the params with values given with -P option</span>
            <span class="n">new_params</span> <span class="o">=</span> <span class="n">common_params</span><span class="p">[</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_ADOPT_STACK_DATA</span><span class="p">][</span>
                <span class="s">&#39;environment&#39;</span><span class="p">][</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">STACK_PARAMETERS</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">STACK_PARAMETERS</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="n">params</span><span class="p">[</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">STACK_PARAMETERS</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_params</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_new_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">tmpl</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">tmpl</span><span class="p">,</span>
                             <span class="n">owner_id</span><span class="o">=</span><span class="n">owner_id</span><span class="p">,</span>
                             <span class="n">nested_depth</span><span class="o">=</span><span class="n">nested_depth</span><span class="p">,</span>
                             <span class="n">user_creds_id</span><span class="o">=</span><span class="n">user_creds_id</span><span class="p">,</span>
                             <span class="n">stack_user_project_id</span><span class="o">=</span><span class="n">stack_user_project_id</span><span class="p">,</span>
                             <span class="n">convergence</span><span class="o">=</span><span class="n">convergence</span><span class="p">,</span>
                             <span class="n">parent_resource</span><span class="o">=</span><span class="n">parent_resource_name</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">common_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_deferred_auth_context</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
        <span class="n">stack</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">stack</span>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.preview_stack"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.preview_stack">[docs]</a>    <span class="k">def</span> <span class="nf">preview_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulates a new stack using the provided template.</span>

<span class="sd">        Note that at this stage the template has already been fetched from the</span>
<span class="sd">        heat-api process if using a template-url.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_name: Name of the stack you want to create.</span>
<span class="sd">        :param template: Template of stack you want to create.</span>
<span class="sd">        :param params: Stack Input Params</span>
<span class="sd">        :param files: Files referenced from the template</span>
<span class="sd">        :param args: Request parameters/args passed from API</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;previewing stack </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">stack_name</span><span class="p">)</span>

        <span class="n">conv_eng</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">convergence_engine</span>
        <span class="k">if</span> <span class="n">conv_eng</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Convergence engine&#39;</span><span class="p">))</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_template_and_validate_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span>
                                                        <span class="n">stack_name</span><span class="p">,</span>
                                                        <span class="n">template</span><span class="p">,</span>
                                                        <span class="n">params</span><span class="p">,</span>
                                                        <span class="n">files</span><span class="p">,</span>
                                                        <span class="n">args</span><span class="p">,</span>
                                                        <span class="n">convergence</span><span class="o">=</span><span class="n">conv_eng</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">api</span><span class="o">.</span><span class="n">format_stack_preview</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.create_stack"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.create_stack">[docs]</a>    <span class="k">def</span> <span class="nf">create_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span>
                     <span class="n">owner_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">nested_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">user_creds_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">stack_user_project_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent_resource_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The create_stack method creates a new stack using the template</span>
<span class="sd">        provided.</span>
<span class="sd">        Note that at this stage the template has already been fetched from the</span>
<span class="sd">        heat-api process if using a template-url.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_name: Name of the stack you want to create.</span>
<span class="sd">        :param template: Template of stack you want to create.</span>
<span class="sd">        :param params: Stack Input Params</span>
<span class="sd">        :param files: Files referenced from the template</span>
<span class="sd">        :param args: Request parameters/args passed from API</span>
<span class="sd">        :param owner_id: parent stack ID for nested stacks, only expected when</span>
<span class="sd">                         called from another heat-engine (not a user option)</span>
<span class="sd">        :param nested_depth: the nested depth for nested stacks, only expected</span>
<span class="sd">                         when called from another heat-engine</span>
<span class="sd">        :param user_creds_id: the parent user_creds record for nested stacks</span>
<span class="sd">        :param stack_user_project_id: the parent stack_user_project_id for</span>
<span class="sd">                         nested stacks</span>
<span class="sd">        :param parent_resource_name: the parent resource name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Creating stack </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">stack_name</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_create_stack_user</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="o">.</span><span class="n">stack_user_project_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">create_stack_user_project_id</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">AuthorizationFailure</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                                    <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_stack_create</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
            <span class="n">_create_stack_user</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
            <span class="c"># Create/Adopt a stack, and create the periodic task if successful</span>
            <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">adopt_stack_data</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">adopt</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">stack</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">stack</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">ADOPT</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">stack</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">stack</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_watch</span><span class="p">:</span>
                    <span class="c"># Schedule a periodic watcher task for this stack</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stack_watch</span><span class="o">.</span><span class="n">start_watch_task</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&quot;Stack create failed, status </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">stack</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

        <span class="n">convergence</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">convergence_engine</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_template_and_validate_stack</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">owner_id</span><span class="p">,</span>
            <span class="n">nested_depth</span><span class="p">,</span> <span class="n">user_creds_id</span><span class="p">,</span> <span class="n">stack_user_project_id</span><span class="p">,</span> <span class="n">convergence</span><span class="p">,</span>
            <span class="n">parent_resource_name</span><span class="p">)</span>

        <span class="c"># once validations are done</span>
        <span class="c"># if convergence is enabled, take convergence path</span>
        <span class="k">if</span> <span class="n">convergence</span><span class="p">:</span>
            <span class="c"># TODO(later): call _create_stack_user(stack)</span>
            <span class="c"># call stack.converge_stack(template=stack.t, action=stack.CREATE)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Convergence engine&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                                  <span class="n">_stack_create</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.update_stack"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.update_stack">[docs]</a>    <span class="k">def</span> <span class="nf">update_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                     <span class="n">files</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The update_stack method updates an existing stack based on the</span>
<span class="sd">        provided template and parameters.</span>
<span class="sd">        Note that at this stage the template has already been fetched from the</span>
<span class="sd">        heat-api process if using a template-url.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to create.</span>
<span class="sd">        :param template: Template of stack you want to create.</span>
<span class="sd">        :param params: Stack Input Params</span>
<span class="sd">        :param files: Files referenced from the template</span>
<span class="sd">        :param args: Request parameters/args passed from API</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Get the database representation of the existing stack</span>
        <span class="n">db_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Updating stack </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">db_stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">current_stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">db_stack</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">SUSPEND</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Updating a stack when it is suspended&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">DELETE</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Updating a stack when it is deleting&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># Now parse the template and any parameters for the updated</span>
        <span class="c"># stack definition.</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_EXISTING</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">env</span><span class="o">.</span><span class="n">patch_previous_parameters</span><span class="p">(</span>
                <span class="n">current_stack</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
                <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_CLEAR_PARAMETERS</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmpl</span><span class="p">[</span><span class="n">tmpl</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">max_resources_per_stack</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">RequestLimitExceeded</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="n">exception</span><span class="o">.</span><span class="n">StackResourceLimitExceeded</span><span class="o">.</span><span class="n">msg_fmt</span><span class="p">)</span>
        <span class="n">stack_name</span> <span class="o">=</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">name</span>
        <span class="n">current_kwargs</span> <span class="o">=</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">get_kwargs_for_cloning</span><span class="p">()</span>

        <span class="n">common_params</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">extract_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">common_params</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_TIMEOUT</span><span class="p">,</span>
                                 <span class="n">current_stack</span><span class="o">.</span><span class="n">timeout_mins</span><span class="p">)</span>
        <span class="n">common_params</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">PARAM_DISABLE_ROLLBACK</span><span class="p">,</span>
                                 <span class="n">current_stack</span><span class="o">.</span><span class="n">disable_rollback</span><span class="p">)</span>

        <span class="n">current_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">common_params</span><span class="p">)</span>
        <span class="n">updated_stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">tmpl</span><span class="p">,</span>
                                     <span class="o">**</span><span class="n">current_kwargs</span><span class="p">)</span>
        <span class="n">updated_stack</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">set_stack_id</span><span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_deferred_auth_context</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">updated_stack</span><span class="p">)</span>
        <span class="n">updated_stack</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="c"># Once all the validations are done</span>
        <span class="c"># if convergence is enabled, take the convergence path</span>
        <span class="k">if</span> <span class="n">current_kwargs</span><span class="p">[</span><span class="s">&#39;convergence&#39;</span><span class="p">]:</span>
            <span class="n">current_stack</span><span class="o">.</span><span class="n">converge_stack</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">tmpl</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="n">eventlet</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
            <span class="n">th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">current_stack</span><span class="p">,</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                                       <span class="n">current_stack</span><span class="o">.</span><span class="n">update</span><span class="p">,</span>
                                                       <span class="n">updated_stack</span><span class="p">,</span>
                                                       <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
            <span class="n">th</span><span class="o">.</span><span class="n">link</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">remove_event</span><span class="p">,</span>
                    <span class="n">current_stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">add_event</span><span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_cancel_update"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.stack_cancel_update">[docs]</a>    <span class="k">def</span> <span class="nf">stack_cancel_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cancel currently running stack update.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack for which to cancel update.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Get the database representation of the existing stack</span>
        <span class="n">db_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>

        <span class="n">current_stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">db_stack</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span>
                                   <span class="n">current_stack</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Cancelling update when stack is </span><span class="si">%s</span><span class="s">&quot;</span>
                    <span class="p">)</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Starting cancel of updating stack </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">db_stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c"># stop the running update and take the lock</span>
        <span class="c"># as we cancel only running update, the acquire_result is</span>
        <span class="c"># always some engine_id, not None</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">current_stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>
        <span class="n">engine_id</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">try_acquire</span><span class="p">()</span>
        <span class="c"># Current engine has the lock</span>
        <span class="k">if</span> <span class="n">engine_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">current_stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&#39;cancel&#39;</span><span class="p">)</span>

        <span class="c"># Another active engine has the lock</span>
        <span class="k">elif</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="o">.</span><span class="n">engine_alive</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">):</span>
            <span class="n">cancel_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_call</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span> <span class="n">engine_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">SEND</span><span class="p">,</span>
                <span class="n">stack_identity</span><span class="o">=</span><span class="n">stack_identity</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">THREAD_CANCEL</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cancel_result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Successfully sent </span><span class="si">%(msg)s</span><span class="s"> message &quot;</span>
                          <span class="s">&quot;to remote task on engine </span><span class="si">%(eng)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">{</span>
                              <span class="s">&#39;eng&#39;</span><span class="p">:</span> <span class="n">engine_id</span><span class="p">,</span> <span class="s">&#39;msg&#39;</span><span class="p">:</span> <span class="s">&#39;cancel&#39;</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">EventSendFailed</span><span class="p">(</span><span class="n">stack_name</span><span class="o">=</span><span class="n">current_stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                <span class="n">engine_id</span><span class="o">=</span><span class="n">engine_id</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.validate_template"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.validate_template">[docs]</a>    <span class="k">def</span> <span class="nf">validate_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The validate_template method uses the stack parser to check</span>
<span class="sd">        the validity of a template.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param template: Template of stack you want to create.</span>
<span class="sd">        :param params: Stack Input Params</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;validate_template&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">template</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;No Template provided.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">webob</span><span class="o">.</span><span class="n">exc</span><span class="o">.</span><span class="n">HTTPBadRequest</span><span class="p">(</span><span class="n">explanation</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">tmpl</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>

        <span class="c"># validate overall template</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tmpl</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;Error&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">)}</span>

        <span class="c"># validate resource classes</span>
        <span class="n">tmpl_resources</span> <span class="o">=</span> <span class="n">tmpl</span><span class="p">[</span><span class="n">tmpl</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">]</span>

        <span class="n">env</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">Environment</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">tmpl_resources</span><span class="p">):</span>
            <span class="n">ResourceClass</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_class</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;Type&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ResourceClass</span> <span class="o">==</span> <span class="n">resources</span><span class="o">.</span><span class="n">template_resource</span><span class="o">.</span><span class="n">TemplateResource</span><span class="p">:</span>
                <span class="c"># we can&#39;t validate a TemplateResource unless we instantiate</span>
                <span class="c"># it as we need to download the template and convert the</span>
                <span class="c"># parameters into properties_schema.</span>
                <span class="k">continue</span>

            <span class="n">props</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">Properties</span><span class="p">(</span>
                <span class="n">ResourceClass</span><span class="o">.</span><span class="n">properties_schema</span><span class="p">,</span>
                <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Properties&#39;</span><span class="p">,</span> <span class="p">{}),</span>
                <span class="n">parent_name</span><span class="o">=</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
                <span class="n">context</span><span class="o">=</span><span class="n">cnxt</span><span class="p">,</span>
                <span class="n">section</span><span class="o">=</span><span class="s">&#39;Properties&#39;</span><span class="p">)</span>
            <span class="n">deletion_policy</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;DeletionPolicy&#39;</span><span class="p">,</span> <span class="s">&#39;Delete&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ResourceClass</span><span class="o">.</span><span class="n">validate_deletion_policy</span><span class="p">(</span><span class="n">deletion_policy</span><span class="p">)</span>
                <span class="n">props</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">with_value</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s">&#39;Error&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">)}</span>

        <span class="c"># validate parameters</span>
        <span class="n">tmpl_params</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">parameters</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">user_params</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">tmpl_params</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">validate_value</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">cnxt</span><span class="p">)</span>
        <span class="n">is_real_param</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tmpl_params</span><span class="o">.</span><span class="n">PSEUDO_PARAMETERS</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">tmpl_params</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">format_validate_parameter</span><span class="p">,</span> <span class="n">is_real_param</span><span class="p">)</span>
        <span class="n">param_groups</span> <span class="o">=</span> <span class="n">parameter_groups</span><span class="o">.</span><span class="n">ParameterGroups</span><span class="p">(</span><span class="n">tmpl</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;Description&#39;</span><span class="p">:</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Description&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
            <span class="s">&#39;Parameters&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">param_groups</span><span class="o">.</span><span class="n">parameter_groups</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s">&#39;ParameterGroups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_groups</span><span class="o">.</span><span class="n">parameter_groups</span>

        <span class="k">return</span> <span class="n">result</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.authenticated_to_backend"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.authenticated_to_backend">[docs]</a>    <span class="k">def</span> <span class="nf">authenticated_to_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verify that the credentials in the RPC context are valid for the</span>
<span class="sd">        current cloud backend.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">clients</span><span class="o">.</span><span class="n">Clients</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)</span><span class="o">.</span><span class="n">authenticated</span><span class="p">()</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.get_template"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.get_template">[docs]</a>    <span class="k">def</span> <span class="nf">get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the template.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to see.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">raw_template</span><span class="o">.</span><span class="n">template</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="k">def</span> <span class="nf">_remote_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">lock_engine_id</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">engine_life_check_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cctxt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span>
            <span class="n">version</span><span class="o">=</span><span class="s">&#39;1.0&#39;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">topic</span><span class="o">=</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">LISTENER_TOPIC</span><span class="p">,</span>
            <span class="n">server</span><span class="o">=</span><span class="n">lock_engine_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cctxt</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">messaging</span><span class="o">.</span><span class="n">MessagingTimeout</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.delete_stack"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.delete_stack">[docs]</a>    <span class="k">def</span> <span class="nf">delete_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The delete_stack method deletes a given stack.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to delete.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Deleting stack </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">st</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">convergence</span><span class="p">:</span>
            <span class="n">empty_template</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">            heat_template_version: 2013-05-23</span>
<span class="s">            description: Empty Template</span>
<span class="s">            &#39;&#39;&#39;</span>
            <span class="n">tmpl</span> <span class="o">=</span> <span class="n">template_format</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">empty_template</span><span class="p">)</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">templatem</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">tmpl</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">converge_stack</span><span class="p">(</span><span class="n">template</span><span class="o">=</span><span class="n">template</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">DELETE</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">lock</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">lock</span><span class="o">.</span><span class="n">try_thread_lock</span><span class="p">()</span> <span class="k">as</span> <span class="n">acquire_result</span><span class="p">:</span>

            <span class="c"># Successfully acquired lock</span>
            <span class="k">if</span> <span class="n">acquire_result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">stop_timers</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_acquired_lock</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span>
                                                               <span class="n">stack</span><span class="o">.</span><span class="n">delete</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c"># Current engine has the lock</span>
        <span class="k">if</span> <span class="n">acquire_result</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">:</span>
            <span class="c"># give threads which are almost complete an opportunity to</span>
            <span class="c"># finish naturally before force stopping them</span>
            <span class="n">eventlet</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c"># Another active engine has the lock</span>
        <span class="k">elif</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="o">.</span><span class="n">engine_alive</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">acquire_result</span><span class="p">):</span>
            <span class="n">stop_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_call</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span> <span class="n">acquire_result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">listener</span><span class="o">.</span><span class="n">STOP_STACK</span><span class="p">,</span>
                <span class="n">stack_identity</span><span class="o">=</span><span class="n">stack_identity</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stop_result</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Successfully stopped remote task on engine </span><span class="si">%s</span><span class="s">&quot;</span>
                          <span class="o">%</span> <span class="n">acquire_result</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StopActionFailed</span><span class="p">(</span><span class="n">stack_name</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                 <span class="n">engine_id</span><span class="o">=</span><span class="n">acquire_result</span><span class="p">)</span>

        <span class="c"># There may be additional resources that we don&#39;t know about</span>
        <span class="c"># if an update was in-progress when the stack was stopped, so</span>
        <span class="c"># reload the stack from the database.</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">st</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                              <span class="n">stack</span><span class="o">.</span><span class="n">delete</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.abandon_stack"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.abandon_stack">[docs]</a>    <span class="k">def</span> <span class="nf">abandon_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The abandon_stack method abandons a given stack.</span>
<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to abandon.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">enable_stack_abandon</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="s">&#39;Stack Abandon&#39;</span><span class="p">)</span>

        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;abandoning stack </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">st</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">st</span><span class="p">)</span>
        <span class="n">lock</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">lock</span><span class="o">.</span><span class="n">thread_lock</span><span class="p">():</span>
            <span class="c"># Get stack details before deleting it.</span>
            <span class="n">stack_info</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">prepare_abandon</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_acquired_lock</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span>
                                                           <span class="n">lock</span><span class="p">,</span>
                                                           <span class="n">stack</span><span class="o">.</span><span class="n">delete</span><span class="p">,</span>
                                                           <span class="n">abandon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stack_info</span>
</div>
<div class="viewcode-block" id="EngineService.list_resource_types"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.list_resource_types">[docs]</a>    <span class="k">def</span> <span class="nf">list_resource_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">support_status</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a list of supported resource types.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">resources</span><span class="o">.</span><span class="n">global_env</span><span class="p">()</span><span class="o">.</span><span class="n">get_types</span><span class="p">(</span><span class="n">support_status</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EngineService.resource_schema"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.resource_schema">[docs]</a>    <span class="k">def</span> <span class="nf">resource_schema</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">type_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the schema of the specified type.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param type_name: Name of the resource type to obtain the schema of.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource_class</span> <span class="o">=</span> <span class="n">resources</span><span class="o">.</span><span class="n">global_env</span><span class="p">()</span><span class="o">.</span><span class="n">get_class</span><span class="p">(</span><span class="n">type_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidResourceType</span><span class="p">,</span>
                <span class="n">exception</span><span class="o">.</span><span class="n">ResourceTypeNotFound</span><span class="p">,</span>
                <span class="n">exception</span><span class="o">.</span><span class="n">TemplateNotFound</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ex</span>

        <span class="k">def</span> <span class="nf">properties_schema</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema_dict</span> <span class="ow">in</span> <span class="n">resource_class</span><span class="o">.</span><span class="n">properties_schema</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="n">properties</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">from_legacy</span><span class="p">(</span><span class="n">schema_dict</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">schema</span><span class="o">.</span><span class="n">implemented</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">attributes_schema</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema_data</span> <span class="ow">in</span> <span class="n">resource_class</span><span class="o">.</span><span class="n">attributes_schema</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">Schema</span><span class="o">.</span><span class="n">from_attribute</span><span class="p">(</span><span class="n">schema_data</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="n">rpc_api</span><span class="o">.</span><span class="n">RES_SCHEMA_RES_TYPE</span><span class="p">:</span> <span class="n">type_name</span><span class="p">,</span>
            <span class="n">rpc_api</span><span class="o">.</span><span class="n">RES_SCHEMA_PROPERTIES</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">properties_schema</span><span class="p">()),</span>
            <span class="n">rpc_api</span><span class="o">.</span><span class="n">RES_SCHEMA_ATTRIBUTES</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">attributes_schema</span><span class="p">()),</span>
        <span class="p">}</span>
</div>
<div class="viewcode-block" id="EngineService.generate_template"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.generate_template">[docs]</a>    <span class="k">def</span> <span class="nf">generate_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">template_type</span><span class="o">=</span><span class="s">&#39;cfn&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a template based on the specified type.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param type_name: Name of the resource type to generate a template for.</span>
<span class="sd">        :param template_type: the template type to generate, cfn or hot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">resources</span><span class="o">.</span><span class="n">global_env</span><span class="p">()</span><span class="o">.</span><span class="n">get_class</span><span class="p">(</span>
                <span class="n">type_name</span><span class="p">)</span><span class="o">.</span><span class="n">resource_to_template</span><span class="p">(</span><span class="n">type_name</span><span class="p">,</span> <span class="n">template_type</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">InvalidResourceType</span><span class="p">,</span>
                <span class="n">exception</span><span class="o">.</span><span class="n">ResourceTypeNotFound</span><span class="p">,</span>
                <span class="n">exception</span><span class="o">.</span><span class="n">TemplateNotFound</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ex</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.list_events"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.list_events">[docs]</a>    <span class="k">def</span> <span class="nf">list_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The list_events method lists all events associated with a given stack.</span>
<span class="sd">        It supports pagination (``limit`` and ``marker``),</span>
<span class="sd">        sorting (``sort_keys`` and ``sort_dir``) and filtering(filters)</span>
<span class="sd">        of the results.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param stack_identity: Name of the stack you want to get events for</span>
<span class="sd">        :param filters: a dict with attribute:value to filter the list</span>
<span class="sd">        :param limit: the number of events to list (integer or string)</span>
<span class="sd">        :param marker: the ID of the last event in the previous page</span>
<span class="sd">        :param sort_keys: an array of fields used to sort the list</span>
<span class="sd">        :param sort_dir: the direction of the sort (&#39;asc&#39; or &#39;desc&#39;).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">stack_identity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="n">events</span> <span class="o">=</span> <span class="n">event_object</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">get_all_by_stack</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span>
                <span class="n">st</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">,</span>
                <span class="n">sort_dir</span><span class="o">=</span><span class="n">sort_dir</span><span class="p">,</span>
                <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">events</span> <span class="o">=</span> <span class="n">event_object</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">get_all_by_tenant</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">sort_keys</span><span class="o">=</span><span class="n">sort_keys</span><span class="p">,</span>
                <span class="n">sort_dir</span><span class="o">=</span><span class="n">sort_dir</span><span class="p">,</span>
                <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>

        <span class="n">stacks</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">get_stack</span><span class="p">(</span><span class="n">stack_id</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">stack_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">:</span>
                <span class="n">stacks</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stacks</span><span class="p">[</span><span class="n">stack_id</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_event</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">Event</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span>
                                                <span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
                                                <span class="n">get_stack</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">stack_id</span><span class="p">)))</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">_authorize_stack_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Filter access to describe_stack_resource for stack in-instance users</span>
<span class="sd">        - The user must map to a User resource defined in the requested stack</span>
<span class="sd">        - The user resource must validate OK against any Policy specified</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># first check whether access is allowed by context user_id</span>
        <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">access_allowed</span><span class="p">(</span><span class="n">cnxt</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="c"># fall back to looking for EC2 credentials in the context</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ec2_creds</span> <span class="o">=</span> <span class="n">jsonutils</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cnxt</span><span class="o">.</span><span class="n">aws_creds</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ec2Credentials&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="n">ec2_creds</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ec2_creds</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">access_key</span> <span class="o">=</span> <span class="n">ec2_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;access&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stack</span><span class="o">.</span><span class="n">access_allowed</span><span class="p">(</span><span class="n">access_key</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_verify_stack_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">resource_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceNotFound</span><span class="p">(</span><span class="n">resource_name</span><span class="o">=</span><span class="n">resource_name</span><span class="p">,</span>
                                             <span class="n">stack_name</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">resource</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceNotAvailable</span><span class="p">(</span><span class="n">resource_name</span><span class="o">=</span><span class="n">resource_name</span><span class="p">)</span>

    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.describe_stack_resource"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.describe_stack_resource">[docs]</a>    <span class="k">def</span> <span class="nf">describe_stack_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">,</span>
                                <span class="n">with_attr</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">heat_stack_user_role</span> <span class="ow">in</span> <span class="n">cnxt</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_authorize_stack_user</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s">&quot;Access denied to resource </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">resource_name</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">Forbidden</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">resource_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceNotFound</span><span class="p">(</span><span class="n">resource_name</span><span class="o">=</span><span class="n">resource_name</span><span class="p">,</span>
                                             <span class="n">stack_name</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">api</span><span class="o">.</span><span class="n">format_stack_resource</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">resource_name</span><span class="p">],</span>
                                         <span class="n">with_attr</span><span class="o">=</span><span class="n">with_attr</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.resource_signal"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.resource_signal">[docs]</a>    <span class="k">def</span> <span class="nf">resource_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span>
                        <span class="n">sync_call</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param sync_call: indicates whether a synchronized call behavior is</span>
<span class="sd">                          expected. This is reserved for CFN WaitCondition</span>
<span class="sd">                          implementation.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">_resource_signal</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">rsrc</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;signaling resource </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            <span class="n">rsrc</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>

            <span class="c"># Refresh the metadata for all other resources, since signals can</span>
            <span class="c"># update metadata which is used by other resources, e.g</span>
            <span class="c"># when signalling a WaitConditionHandle resource, and other</span>
            <span class="c"># resources may refer to WaitCondition Fn::GetAtt Data</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
                        <span class="n">r</span><span class="o">.</span><span class="n">action</span> <span class="o">!=</span> <span class="n">r</span><span class="o">.</span><span class="n">INIT</span><span class="p">):</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">metadata_update</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>

        <span class="c"># This is not &quot;nice&quot; converting to the stored context here,</span>
        <span class="c"># but this happens because the keystone user associated with the</span>
        <span class="c"># signal doesn&#39;t have permission to read the secret key of</span>
        <span class="c"># the user associated with the cfn-credentials file</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">use_stored_context</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verify_stack_resource</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">)</span>

        <span class="n">rsrc</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">rsrc</span><span class="o">.</span><span class="n">signal</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sync_call</span><span class="p">:</span>
                <span class="n">_resource_signal</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">rsrc</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">rsrc</span><span class="o">.</span><span class="n">metadata_get</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">_resource_signal</span><span class="p">,</span>
                                            <span class="n">stack</span><span class="p">,</span> <span class="n">rsrc</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.find_physical_resource"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.find_physical_resource">[docs]</a>    <span class="k">def</span> <span class="nf">find_physical_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">physical_resource_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return an identifier for the resource with the specified physical</span>
<span class="sd">        resource ID.</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param physical_resource_id: The physical resource ID to look up.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_by_physical_resource_id</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">physical_resource_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">PhysicalResourceNotFound</span><span class="p">(</span>
                <span class="n">resource_id</span><span class="o">=</span><span class="n">physical_resource_id</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_id</span><span class="o">=</span><span class="n">rs</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">rs</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.describe_stack_resources"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.describe_stack_resources">[docs]</a>    <span class="k">def</span> <span class="nf">describe_stack_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_stack_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">resource_name</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">name</span> <span class="o">==</span> <span class="n">resource_name</span><span class="p">]</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.list_stack_resources"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.list_stack_resources">[docs]</a>    <span class="k">def</span> <span class="nf">list_stack_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">nested_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nested_depth</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">max_nested_stack_depth</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_stack_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">iter_resources</span><span class="p">(</span><span class="n">depth</span><span class="p">)]</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_suspend"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.stack_suspend">[docs]</a>    <span class="k">def</span> <span class="nf">stack_suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Handle request to perform suspend action on a stack</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">_stack_suspend</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;suspending stack </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">suspend</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                              <span class="n">_stack_suspend</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_resume"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.stack_resume">[docs]</a>    <span class="k">def</span> <span class="nf">stack_resume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Handle request to perform a resume action on a stack</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">_stack_resume</span><span class="p">(</span><span class="n">stack</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;resuming stack </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                              <span class="n">_stack_resume</span><span class="p">,</span> <span class="n">stack</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_snapshot"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.stack_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">stack_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_stack_snapshot</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;snapshotting stack </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">snapshot</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">prepare_abandon</span><span class="p">()</span>
            <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="p">{</span><span class="s">&#39;data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="n">stack</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                 <span class="s">&#39;status_reason&#39;</span><span class="p">:</span> <span class="n">stack</span><span class="o">.</span><span class="n">status_reason</span><span class="p">})</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">stack</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%(stack)s</span><span class="s"> is in state </span><span class="si">%(action)s</span><span class="s">_IN_PROGRESS, &#39;</span>
                         <span class="s">&#39;snapshot is not permitted.&#39;</span><span class="p">),</span> <span class="p">{</span>
                             <span class="s">&#39;stack&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">stack</span><span class="p">),</span>
                             <span class="s">&#39;action&#39;</span><span class="p">:</span> <span class="n">stack</span><span class="o">.</span><span class="n">action</span><span class="p">})</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ActionInProgress</span><span class="p">(</span><span class="n">stack_name</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                             <span class="n">action</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span><span class="p">)</span>

        <span class="n">lock</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">lock</span><span class="o">.</span><span class="n">thread_lock</span><span class="p">():</span>
            <span class="n">snapshot</span> <span class="o">=</span> <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="p">{</span>
                <span class="s">&#39;tenant&#39;</span><span class="p">:</span> <span class="n">cnxt</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">,</span>
                <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s">&#39;stack_id&#39;</span><span class="p">:</span> <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="s">&#39;IN_PROGRESS&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_acquired_lock</span><span class="p">(</span>
                <span class="n">stack</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">_stack_snapshot</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">api</span><span class="o">.</span><span class="n">format_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.show_snapshot"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.show_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">show_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">snapshot</span> <span class="o">=</span> <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">get_snapshot_by_stack</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">api</span><span class="o">.</span><span class="n">format_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.delete_snapshot"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.delete_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">delete_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_delete_snapshot</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">):</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">delete_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
            <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="n">snapshot</span> <span class="o">=</span> <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">get_snapshot_by_stack</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">stack</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Deleting in-progress snapshot&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">_delete_snapshot</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_check"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.stack_check">[docs]</a>    <span class="k">def</span> <span class="nf">stack_check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Handle request to perform a check action on a stack</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&quot;Checking stack </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                              <span class="n">stack</span><span class="o">.</span><span class="n">check</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_restore"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.stack_restore">[docs]</a>    <span class="k">def</span> <span class="nf">stack_restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_stack_restore</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;restoring stack </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="n">snapshot</span> <span class="o">=</span> <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">get_snapshot_by_stack</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">snapshot_id</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_lock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                                              <span class="n">_stack_restore</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.stack_list_snapshots"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.stack_list_snapshots">[docs]</a>    <span class="k">def</span> <span class="nf">stack_list_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span> <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.metadata_update"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.metadata_update">[docs]</a>    <span class="k">def</span> <span class="nf">metadata_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">,</span>
                        <span class="n">resource_name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the metadata for the given resource.</span>
<span class="sd">        DEPRECATED: Use resource_signal instead</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;metadata_update is deprecated, &#39;</span>
                      <span class="s">&#39;use resource_signal instead&#39;</span><span class="p">,</span>
                      <span class="ne">DeprecationWarning</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stack</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack_identity</span><span class="p">)</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resource_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stack</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceNotFound</span><span class="p">(</span><span class="n">resource_name</span><span class="o">=</span><span class="n">resource_name</span><span class="p">,</span>
                                             <span class="n">stack_name</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">resource</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span>
        <span class="n">resource</span><span class="o">.</span><span class="n">metadata_update</span><span class="p">(</span><span class="n">new_metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c"># This is not &quot;nice&quot; converting to the stored context here,</span>
        <span class="c"># but this happens because the keystone user associated with the</span>
        <span class="c"># WaitCondition doesn&#39;t have permission to read the secret key of</span>
        <span class="c"># the user associated with the cfn-credentials file</span>
        <span class="n">refresh_stack</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                          <span class="n">use_stored_context</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c"># Refresh the metadata for all other resources, since we expect</span>
        <span class="c"># resource_name to be a WaitCondition resource, and other</span>
        <span class="c"># resources may refer to WaitCondition Fn::GetAtt Data, which</span>
        <span class="c"># is updated here.</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">refresh_stack</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">resource_name</span> <span class="ow">and</span> <span class="n">res</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">metadata_update</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">resource</span><span class="o">.</span><span class="n">metadata_get</span><span class="p">()</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.create_watch_data"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.create_watch_data">[docs]</a>    <span class="k">def</span> <span class="nf">create_watch_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">watch_name</span><span class="p">,</span> <span class="n">stats_data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This could be used by CloudWatch and WaitConditions</span>
<span class="sd">        and treat HA service events like any other CloudWatch.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">get_matching_watches</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">watch_name</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">watchrule</span><span class="o">.</span><span class="n">WatchRule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">watch_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">wr</span> <span class="ow">in</span> <span class="n">watch_rule</span><span class="o">.</span><span class="n">WatchRule</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">watchrule</span><span class="o">.</span><span class="n">rule_can_use_sample</span><span class="p">(</span><span class="n">wr</span><span class="p">,</span> <span class="n">stats_data</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">watchrule</span><span class="o">.</span><span class="n">WatchRule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">watch</span><span class="o">=</span><span class="n">wr</span><span class="p">)</span>

        <span class="n">rule_run</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">get_matching_watches</span><span class="p">():</span>
            <span class="n">rule</span><span class="o">.</span><span class="n">create_watch_data</span><span class="p">(</span><span class="n">stats_data</span><span class="p">)</span>
            <span class="n">rule_run</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rule_run</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">watch_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">watch_name</span> <span class="o">=</span> <span class="s">&#39;Unknown&#39;</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">WatchRuleNotFound</span><span class="p">(</span><span class="n">watch_name</span><span class="o">=</span><span class="n">watch_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stats_data</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.show_watch"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.show_watch">[docs]</a>    <span class="k">def</span> <span class="nf">show_watch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">watch_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The show_watch method returns the attributes of one watch/alarm</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param watch_name: Name of the watch you want to see, or None to see</span>
<span class="sd">            all</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">watch_name</span><span class="p">:</span>
            <span class="n">wrn</span> <span class="o">=</span> <span class="p">[</span><span class="n">watch_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wrn</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">watch_rule</span><span class="o">.</span><span class="n">WatchRule</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s">&#39;show_watch (all) db error </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="n">wrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">watchrule</span><span class="o">.</span><span class="n">WatchRule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wrn</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_watch</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wrs</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.show_watch_metric"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.show_watch_metric">[docs]</a>    <span class="k">def</span> <span class="nf">show_watch_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">metric_namespace</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">metric_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The show_watch method returns the datapoints for a metric</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param metric_namespace: Name of the namespace you want to see, or None</span>
<span class="sd">            to see all</span>
<span class="sd">        :param metric_name: Name of the metric you want to see, or None to see</span>
<span class="sd">            all</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># DB API and schema does not yet allow us to easily query by</span>
        <span class="c"># namespace/metric, but we will want this at some point</span>
        <span class="c"># for now, the API can query all metric data and filter locally</span>
        <span class="k">if</span> <span class="n">metric_namespace</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">metric_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&quot;Filtering by namespace/metric not yet supported&quot;</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">wds</span> <span class="o">=</span> <span class="n">watch_data</span><span class="o">.</span><span class="n">WatchData</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s">&#39;show_metric (all) db error </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">format_watch_data</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">wds</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.set_watch_state"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.set_watch_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_watch_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">watch_name</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Temporarily set the state of a given watch</span>

<span class="sd">        :param cnxt: RPC context.</span>
<span class="sd">        :param watch_name: Name of the watch</span>
<span class="sd">        :param state: State (must be one defined in WatchRule class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wr</span> <span class="o">=</span> <span class="n">watchrule</span><span class="o">.</span><span class="n">WatchRule</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">watch_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wr</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">rpc_api</span><span class="o">.</span><span class="n">WATCH_STATE_CEILOMETER_CONTROLLED</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="n">wr</span><span class="o">.</span><span class="n">set_watch_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">wr</span><span class="o">.</span><span class="n">stack_id</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>

        <span class="c"># Return the watch with the state overridden to indicate success</span>
        <span class="c"># We do not update the timestamps as we are not modifying the DB</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">format_watch</span><span class="p">(</span><span class="n">wr</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="n">rpc_api</span><span class="o">.</span><span class="n">WATCH_STATE_VALUE</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.show_software_config"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.show_software_config">[docs]</a>    <span class="k">def</span> <span class="nf">show_software_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">config_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">show_software_config</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">config_id</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.create_software_config"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.create_software_config">[docs]</a>    <span class="k">def</span> <span class="nf">create_software_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span>
                               <span class="n">inputs</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">create_software_config</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
            <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.delete_software_config"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.delete_software_config">[docs]</a>    <span class="k">def</span> <span class="nf">delete_software_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">config_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">delete_software_config</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">config_id</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.list_software_deployments"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.list_software_deployments">[docs]</a>    <span class="k">def</span> <span class="nf">list_software_deployments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">server_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">list_software_deployments</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">server_id</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.metadata_software_deployments"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.metadata_software_deployments">[docs]</a>    <span class="k">def</span> <span class="nf">metadata_software_deployments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">server_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">metadata_software_deployments</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">server_id</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.show_software_deployment"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.show_software_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">show_software_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">show_software_deployment</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.create_software_deployment"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.create_software_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">create_software_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">server_id</span><span class="p">,</span> <span class="n">config_id</span><span class="p">,</span>
                                   <span class="n">input_values</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
                                   <span class="n">status_reason</span><span class="p">,</span> <span class="n">stack_user_project_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">create_software_deployment</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">server_id</span><span class="o">=</span><span class="n">server_id</span><span class="p">,</span>
            <span class="n">config_id</span><span class="o">=</span><span class="n">config_id</span><span class="p">,</span>
            <span class="n">input_values</span><span class="o">=</span><span class="n">input_values</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="n">status_reason</span><span class="o">=</span><span class="n">status_reason</span><span class="p">,</span>
            <span class="n">stack_user_project_id</span><span class="o">=</span><span class="n">stack_user_project_id</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.signal_software_deployment"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.signal_software_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">signal_software_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">,</span> <span class="n">details</span><span class="p">,</span>
                                   <span class="n">updated_at</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">signal_software_deployment</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">deployment_id</span><span class="o">=</span><span class="n">deployment_id</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">,</span>
            <span class="n">updated_at</span><span class="o">=</span><span class="n">updated_at</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.update_software_deployment"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.update_software_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">update_software_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">,</span> <span class="n">config_id</span><span class="p">,</span>
                                   <span class="n">input_values</span><span class="p">,</span> <span class="n">output_values</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
                                   <span class="n">status</span><span class="p">,</span> <span class="n">status_reason</span><span class="p">,</span> <span class="n">updated_at</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">update_software_deployment</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span>
            <span class="n">deployment_id</span><span class="o">=</span><span class="n">deployment_id</span><span class="p">,</span>
            <span class="n">config_id</span><span class="o">=</span><span class="n">config_id</span><span class="p">,</span>
            <span class="n">input_values</span><span class="o">=</span><span class="n">input_values</span><span class="p">,</span>
            <span class="n">output_values</span><span class="o">=</span><span class="n">output_values</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="n">status_reason</span><span class="o">=</span><span class="n">status_reason</span><span class="p">,</span>
            <span class="n">updated_at</span><span class="o">=</span><span class="n">updated_at</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.delete_software_deployment"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.delete_software_deployment">[docs]</a>    <span class="k">def</span> <span class="nf">delete_software_deployment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">software_config</span><span class="o">.</span><span class="n">delete_software_deployment</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">)</span>
</div>
    <span class="nd">@context.request_context</span>
<div class="viewcode-block" id="EngineService.list_services"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.list_services">[docs]</a>    <span class="k">def</span> <span class="nf">list_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnxt</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">service_utils</span><span class="o">.</span><span class="n">format_service</span><span class="p">(</span><span class="n">srv</span><span class="p">)</span>
                  <span class="k">for</span> <span class="n">srv</span> <span class="ow">in</span> <span class="n">service_objects</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">result</span>
</div>
<div class="viewcode-block" id="EngineService.service_manage_report"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.service_manage_report">[docs]</a>    <span class="k">def</span> <span class="nf">service_manage_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cnxt</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_admin_context</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Service is already running</span>
            <span class="n">service_objects</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">update_by_id</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span><span class="p">,</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">deleted_at</span><span class="o">=</span><span class="bp">None</span><span class="p">))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Service </span><span class="si">%s</span><span class="s"> is updated&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">service_ref</span> <span class="o">=</span> <span class="n">service_objects</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">cnxt</span><span class="p">,</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
                     <span class="n">hostname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
                     <span class="n">binary</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="p">,</span>
                     <span class="n">engine_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">,</span>
                     <span class="n">topic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span>
                     <span class="n">report_interval</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">periodic_interval</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">service_ref</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Service </span><span class="si">%s</span><span class="s"> is started&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="EngineService.service_manage_cleanup"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.service_manage_cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">service_manage_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cnxt</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_admin_context</span><span class="p">()</span>
        <span class="n">last_updated_window</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">periodic_interval</span><span class="p">)</span>
        <span class="n">time_line</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span>
            <span class="n">seconds</span><span class="o">=</span><span class="n">last_updated_window</span><span class="p">)</span>

        <span class="n">service_refs</span> <span class="o">=</span> <span class="n">service_objects</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">get_all_by_args</span><span class="p">(</span>
            <span class="n">cnxt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binary</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">service_ref</span> <span class="ow">in</span> <span class="n">service_refs</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">service_ref</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">service_id</span> <span class="ow">or</span>
                    <span class="n">service_ref</span><span class="p">[</span><span class="s">&#39;deleted_at&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">or</span>
                    <span class="n">service_ref</span><span class="p">[</span><span class="s">&#39;updated_at&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">service_ref</span><span class="p">[</span><span class="s">&#39;updated_at&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">time_line</span><span class="p">:</span>
                <span class="c"># hasn&#39;t been updated, assuming it&#39;s died.</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Service </span><span class="si">%s</span><span class="s"> was aborted&#39;</span><span class="p">),</span> <span class="n">service_ref</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
                <span class="n">service_objects</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">service_ref</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="EngineService.reset_stack_status"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.service.html#heat.engine.service.EngineService.reset_stack_status">[docs]</a>    <span class="k">def</span> <span class="nf">reset_stack_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cnxt</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_admin_context</span><span class="p">()</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">}</span>
        <span class="n">stacks</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span>
                                            <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
                                            <span class="n">tenant_safe</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">:</span>
            <span class="n">lock</span> <span class="o">=</span> <span class="n">stack_lock</span><span class="o">.</span><span class="n">StackLock</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_id</span><span class="p">)</span>
            <span class="c"># If stacklock is released, means stack status may changed.</span>
            <span class="n">engine_id</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="n">get_engine_id</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">engine_id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c"># Try to steal the lock and set status to failed.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">retry</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ActionInProgress</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">stk</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cnxt</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">,</span>
                                    <span class="n">use_stored_context</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Engine </span><span class="si">%(engine)s</span><span class="s"> went down when stack </span><span class="si">%(stack_id)s</span><span class="s">&#39;</span>
                         <span class="s">&#39; was in action </span><span class="si">%(action)s</span><span class="s">&#39;</span><span class="p">),</span>
                     <span class="p">{</span><span class="s">&#39;engine&#39;</span><span class="p">:</span> <span class="n">engine_id</span><span class="p">,</span> <span class="s">&#39;action&#39;</span><span class="p">:</span> <span class="n">stk</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                      <span class="s">&#39;stack_id&#39;</span><span class="p">:</span> <span class="n">stk</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
            <span class="c"># Set stack status to FAILED.</span>
            <span class="n">status_reason</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Engine went down during stack </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">stk</span><span class="o">.</span><span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_group_mgr</span><span class="o">.</span><span class="n">start_with_acquired_lock</span><span class="p">(</span>
                <span class="n">stk</span><span class="p">,</span> <span class="n">lock</span><span class="p">,</span> <span class="n">stk</span><span class="o">.</span><span class="n">state_set</span><span class="p">,</span> <span class="n">stk</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                <span class="n">stk</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">status_reason</span><span class="p">)</span>
            <span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../../../raxdox/index.html">Supported Resources</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2012,2015 Heat Developers.
      Last updated on Wed May 20 12:03:06 2015, commit 58910c6.
    </div>
  </body>
</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>heat.engine.stack &mdash; Supported Resources</title>
    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2015.2.dev78',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Supported Resources" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="../../../raxdox/index.html">Supported Resources</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for heat.engine.stack</h1><div class="highlight"><pre>
<span class="c">#</span>
<span class="c">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c">#    a copy of the License at</span>
<span class="c">#</span>
<span class="c">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c">#    License for the specific language governing permissions and limitations</span>
<span class="c">#    under the License.</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">oslo_config</span> <span class="kn">import</span> <span class="n">cfg</span>
<span class="kn">from</span> <span class="nn">oslo_log</span> <span class="kn">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">encodeutils</span>
<span class="kn">from</span> <span class="nn">osprofiler</span> <span class="kn">import</span> <span class="n">profiler</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">context</span> <span class="k">as</span> <span class="n">common_context</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">exception</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LE</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LI</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LW</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">identifier</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">lifecycle_plugin_utils</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">dependencies</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">function</span>
<span class="kn">from</span> <span class="nn">heat.engine.notification</span> <span class="kn">import</span> <span class="n">stack</span> <span class="k">as</span> <span class="n">notification</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">parameter_groups</span> <span class="k">as</span> <span class="n">param_groups</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">resource</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">scheduler</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">template</span> <span class="k">as</span> <span class="n">tmpl</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">update</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">resource</span> <span class="k">as</span> <span class="n">resource_objects</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">snapshot</span> <span class="k">as</span> <span class="n">snapshot_object</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">stack</span> <span class="k">as</span> <span class="n">stack_object</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">stack_tag</span> <span class="k">as</span> <span class="n">stack_tag_object</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">user_creds</span> <span class="k">as</span> <span class="n">ucreds_object</span>
<span class="kn">from</span> <span class="nn">heat.rpc</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">rpc_api</span>

<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s">&#39;error_wait_time&#39;</span><span class="p">,</span> <span class="s">&#39;heat.common.config&#39;</span><span class="p">)</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ForcedCancel"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.ForcedCancel">[docs]</a><span class="k">class</span> <span class="nc">ForcedCancel</span><span class="p">(</span><span class="ne">BaseException</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception raised to cancel task execution.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;Operation cancelled&quot;</span>

</div>
<div class="viewcode-block" id="Stack"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack">[docs]</a><span class="k">class</span> <span class="nc">Stack</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">Mapping</span><span class="p">):</span>

    <span class="n">ACTIONS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">CREATE</span><span class="p">,</span> <span class="n">DELETE</span><span class="p">,</span> <span class="n">UPDATE</span><span class="p">,</span> <span class="n">ROLLBACK</span><span class="p">,</span> <span class="n">SUSPEND</span><span class="p">,</span> <span class="n">RESUME</span><span class="p">,</span> <span class="n">ADOPT</span><span class="p">,</span>
        <span class="n">SNAPSHOT</span><span class="p">,</span> <span class="n">CHECK</span><span class="p">,</span> <span class="n">RESTORE</span>
    <span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s">&#39;CREATE&#39;</span><span class="p">,</span> <span class="s">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s">&#39;UPDATE&#39;</span><span class="p">,</span> <span class="s">&#39;ROLLBACK&#39;</span><span class="p">,</span> <span class="s">&#39;SUSPEND&#39;</span><span class="p">,</span> <span class="s">&#39;RESUME&#39;</span><span class="p">,</span> <span class="s">&#39;ADOPT&#39;</span><span class="p">,</span>
        <span class="s">&#39;SNAPSHOT&#39;</span><span class="p">,</span> <span class="s">&#39;CHECK&#39;</span><span class="p">,</span> <span class="s">&#39;RESTORE&#39;</span>
    <span class="p">)</span>

    <span class="n">STATUSES</span> <span class="o">=</span> <span class="p">(</span><span class="n">IN_PROGRESS</span><span class="p">,</span> <span class="n">FAILED</span><span class="p">,</span> <span class="n">COMPLETE</span>
                <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;IN_PROGRESS&#39;</span><span class="p">,</span> <span class="s">&#39;FAILED&#39;</span><span class="p">,</span> <span class="s">&#39;COMPLETE&#39;</span><span class="p">)</span>

    <span class="n">_zones</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">stack_name</span><span class="p">,</span> <span class="n">tmpl</span><span class="p">,</span>
                 <span class="n">stack_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">status_reason</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">timeout_mins</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">resolve_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">disable_rollback</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">parent_resource</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">owner_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">adopt_stack_data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stack_user_project_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">created_time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">updated_time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">user_creds_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tenant_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">use_stored_context</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">nested_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">strict_validate</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">convergence</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">current_traversal</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialise from a context, name, Template object and (optionally)</span>
<span class="sd">        Environment object. The database ID may also be initialised, if the</span>
<span class="sd">        stack is already in the database.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">_validate_stack_name</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&quot;[a-zA-Z][a-zA-Z0-9_.-]*$&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Invalid stack name </span><span class="si">%s</span><span class="s"> must contain &#39;</span>
                            <span class="s">&#39;only alphanumeric or </span><span class="se">\&quot;</span><span class="s">_-.</span><span class="se">\&quot;</span><span class="s"> characters, &#39;</span>
                            <span class="s">&#39;must start with alpha&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">name</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">owner_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">_validate_stack_name</span><span class="p">(</span><span class="n">stack_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">stack_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span> <span class="o">=</span> <span class="n">owner_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">tmpl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">stack_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADOPT</span> <span class="k">if</span> <span class="n">adopt_stack_data</span> <span class="k">else</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span> <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">action</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span> <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="n">status_reason</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span> <span class="o">=</span> <span class="n">timeout_mins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span> <span class="o">=</span> <span class="n">disable_rollback</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource_name</span> <span class="o">=</span> <span class="n">parent_resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_resource</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_access_allowed_handlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_resources</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adopt_stack_data</span> <span class="o">=</span> <span class="n">adopt_stack_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack_user_project_id</span> <span class="o">=</span> <span class="n">stack_user_project_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="n">created_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">updated_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span> <span class="o">=</span> <span class="n">user_creds_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nested_depth</span> <span class="o">=</span> <span class="n">nested_depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict_validate</span> <span class="o">=</span> <span class="n">strict_validate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span> <span class="o">=</span> <span class="n">convergence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span> <span class="o">=</span> <span class="n">current_traversal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>

        <span class="k">if</span> <span class="n">use_stored_context</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stored_context</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">clients</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">clients</span>

        <span class="c"># This will use the provided tenant ID when loading the stack</span>
        <span class="c"># from the DB or get it from the context for new stacks.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span> <span class="o">=</span> <span class="n">tenant_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">tenant_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">username</span>

        <span class="n">resources</span><span class="o">.</span><span class="n">initialise</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">parameters</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">(),</span>
            <span class="n">user_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
            <span class="n">param_defaults</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">param_defaults</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_param_stackid</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">resolve_data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_static_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">OUTPUTS</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Stack.env"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.env">[docs]</a>    <span class="k">def</span> <span class="nf">env</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is a helper to allow resources to access stack.env.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">env</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stack.parent_resource"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.parent_resource">[docs]</a>    <span class="k">def</span> <span class="nf">parent_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dynamically load up the parent_resource.</span>

<span class="sd">        Note: this should only be used by &quot;Fn::ResourceFacade&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_resource</span>

        <span class="c"># we need both parent name and owner id.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource_name</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">owner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">stack_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_resource</span> <span class="o">=</span> <span class="n">owner</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_resource_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_resource</span>
</div>
<div class="viewcode-block" id="Stack.stored_context"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.stored_context">[docs]</a>    <span class="k">def</span> <span class="nf">stored_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">:</span>
            <span class="n">creds_obj</span> <span class="o">=</span> <span class="n">ucreds_object</span><span class="o">.</span><span class="n">UserCreds</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">)</span>
            <span class="c"># Maintain request_id from self.context so we retain traceability</span>
            <span class="c"># in situations where servicing a request requires switching from</span>
            <span class="c"># the request context to the stored context</span>
            <span class="n">creds</span> <span class="o">=</span> <span class="n">creds_obj</span><span class="o">.</span><span class="n">obj_to_primitive</span><span class="p">()[</span><span class="s">&quot;versioned_object.data&quot;</span><span class="p">]</span>
            <span class="n">creds</span><span class="p">[</span><span class="s">&#39;request_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">request_id</span>
            <span class="c"># We don&#39;t store roles in the user_creds table, so disable the</span>
            <span class="c"># policy check for admin by setting is_admin=False.</span>
            <span class="n">creds</span><span class="p">[</span><span class="s">&#39;is_admin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span> <span class="n">common_context</span><span class="o">.</span><span class="n">RequestContext</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">creds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Attempt to use stored_context with no user_creds&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stack.resources"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.resources">[docs]</a>    <span class="k">def</span> <span class="nf">resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
                                   <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="ow">in</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">resource_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="c"># There is no need to continue storing the db resources</span>
            <span class="c"># after resource creation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db_resources</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span>
</div>
<div class="viewcode-block" id="Stack.iter_resources"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.iter_resources">[docs]</a>    <span class="k">def</span> <span class="nf">iter_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nested_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Iterates over all the resources in a stack, including nested stacks up</span>
<span class="sd">        to `nested_depth` levels below.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">res</span>

            <span class="n">get_nested</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">&#39;nested&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">get_nested</span><span class="p">)</span> <span class="ow">or</span> <span class="n">nested_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">nested_stack</span> <span class="o">=</span> <span class="n">get_nested</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">nested_stack</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">nested_res</span> <span class="ow">in</span> <span class="n">nested_stack</span><span class="o">.</span><span class="n">iter_resources</span><span class="p">(</span><span class="n">nested_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">nested_res</span>
</div>
<div class="viewcode-block" id="Stack.db_resource_get"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.db_resource_get">[docs]</a>    <span class="k">def</span> <span class="nf">db_resource_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_resources</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_db_resources</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_all_by_stack</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db_resources</span> <span class="o">=</span> <span class="n">_db_resources</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stack.dependencies"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dependencies</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">itervalues</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span>
</div>
<div class="viewcode-block" id="Stack.reset_dependencies"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.reset_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">reset_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span> <span class="o">=</span> <span class="bp">None</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stack.root_stack"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.root_stack">[docs]</a>    <span class="k">def</span> <span class="nf">root_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the root stack if this is nested (otherwise return self).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_resource</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource</span><span class="o">.</span><span class="n">stack</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">root_stack</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
<div class="viewcode-block" id="Stack.object_path_in_stack"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.object_path_in_stack">[docs]</a>    <span class="k">def</span> <span class="nf">object_path_in_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If this is not nested return (None, self), else return stack resources</span>
<span class="sd">        and stacks in path from the root stack and including this stack</span>

<span class="sd">        :returns: a list of (stack_resource, stack) tuples</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource</span><span class="o">.</span><span class="n">stack</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">object_path_in_stack</span><span class="p">()</span>
            <span class="n">path</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent_resource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)])</span>
            <span class="k">return</span> <span class="n">path</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="p">)]</span>
</div>
<div class="viewcode-block" id="Stack.path_in_stack"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.path_in_stack">[docs]</a>    <span class="k">def</span> <span class="nf">path_in_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        If this is not nested return (None, self.name), else return tuples of</span>
<span class="sd">        names (stack_resource.name, stack.name) in path from the root stack and</span>
<span class="sd">        including this stack.</span>

<span class="sd">        :returns: a list of (string, string) tuples.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">opis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_path_in_stack</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">stckres</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">stckres</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
                 <span class="n">stck</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">stck</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">stckres</span><span class="p">,</span> <span class="n">stck</span> <span class="ow">in</span> <span class="n">opis</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Stack.total_resources"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.total_resources">[docs]</a>    <span class="k">def</span> <span class="nf">total_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the total number of resources in a stack, including nested</span>
<span class="sd">        stacks below.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">total_nested</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
            <span class="n">get_nested</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">&#39;nested&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">get_nested</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nested_stack</span> <span class="o">=</span> <span class="n">get_nested</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                    <span class="c"># when an delete is underway, a nested stack can</span>
                    <span class="c"># disapear at any moment.</span>
                    <span class="k">return</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">nested_stack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">nested_stack</span><span class="o">.</span><span class="n">total_resources</span><span class="p">()</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">total_nested</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">itervalues</span><span class="p">())</span>
</div>
    <span class="k">def</span> <span class="nf">_set_param_stackid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update self.parameters with the current ARN which is then provided</span>
<span class="sd">        via the Parameters class as the StackId pseudo parameter</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">set_stack_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">()):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s">&quot;Unable to set parameters StackId identifier&quot;</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Stack.get_dep_attrs"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.get_dep_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">get_dep_attrs</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the set of dependent attributes for specified resource name by</span>
<span class="sd">        inspecting all resources and outputs in template.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">attr_lists</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">((</span><span class="n">res</span><span class="o">.</span><span class="n">dep_attrs</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>
                                      <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">),</span>
                                     <span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">dep_attrs</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Value&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
                                                         <span class="n">resource_name</span><span class="p">)</span>
                                      <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">itervalues</span><span class="p">(</span><span class="n">outputs</span><span class="p">)))</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">attr_lists</span><span class="p">))</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_dependencies</span><span class="p">(</span><span class="n">resources</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the dependency graph for a list of resources.&#39;&#39;&#39;</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="n">dependencies</span><span class="o">.</span><span class="n">Dependencies</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">add_dependencies</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">deps</span>

    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Stack.load"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">stack_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent_resource</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="n">show_deleted</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">use_stored_context</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">force_reload</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Retrieve a Stack from the database.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">stack</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span>
                <span class="n">context</span><span class="p">,</span>
                <span class="n">stack_id</span><span class="p">,</span>
                <span class="n">show_deleted</span><span class="o">=</span><span class="n">show_deleted</span><span class="p">,</span>
                <span class="n">eager_load</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stack</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;No stack exists with id &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">stack_id</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">force_reload</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">refresh</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">_from_db</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">parent_resource</span><span class="o">=</span><span class="n">parent_resource</span><span class="p">,</span>
                            <span class="n">use_stored_context</span><span class="o">=</span><span class="n">use_stored_context</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Stack.load_all"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.load_all">[docs]</a>    <span class="k">def</span> <span class="nf">load_all</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">sort_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tenant_safe</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">show_deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">resolve_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">show_nested</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">show_hidden</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">stacks</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span>
            <span class="n">context</span><span class="p">,</span>
            <span class="n">limit</span><span class="p">,</span>
            <span class="n">sort_keys</span><span class="p">,</span>
            <span class="n">marker</span><span class="p">,</span>
            <span class="n">sort_dir</span><span class="p">,</span>
            <span class="n">filters</span><span class="p">,</span>
            <span class="n">tenant_safe</span><span class="p">,</span>
            <span class="n">show_deleted</span><span class="p">,</span>
            <span class="n">show_nested</span><span class="p">,</span>
            <span class="n">show_hidden</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">stack</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">cls</span><span class="o">.</span><span class="n">_from_db</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">resolve_data</span><span class="o">=</span><span class="n">resolve_data</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_from_db</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">parent_resource</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">resolve_data</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">use_stored_context</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">Template</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">context</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">raw_template_id</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">raw_template</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">tags</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span>
                   <span class="n">stack_id</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                   <span class="n">action</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                   <span class="n">status_reason</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">status_reason</span><span class="p">,</span>
                   <span class="n">timeout_mins</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                   <span class="n">resolve_data</span><span class="o">=</span><span class="n">resolve_data</span><span class="p">,</span>
                   <span class="n">disable_rollback</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">disable_rollback</span><span class="p">,</span>
                   <span class="n">parent_resource</span><span class="o">=</span><span class="n">parent_resource</span><span class="p">,</span>
                   <span class="n">owner_id</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">owner_id</span><span class="p">,</span>
                   <span class="n">stack_user_project_id</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">stack_user_project_id</span><span class="p">,</span>
                   <span class="n">created_time</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">created_at</span><span class="p">,</span>
                   <span class="n">updated_time</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">updated_at</span><span class="p">,</span>
                   <span class="n">user_creds_id</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">,</span> <span class="n">tenant_id</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">tenant</span><span class="p">,</span>
                   <span class="n">use_stored_context</span><span class="o">=</span><span class="n">use_stored_context</span><span class="p">,</span>
                   <span class="n">username</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">convergence</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">convergence</span><span class="p">,</span>
                   <span class="n">current_traversal</span><span class="o">=</span><span class="n">stack</span><span class="o">.</span><span class="n">current_traversal</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>

<div class="viewcode-block" id="Stack.get_kwargs_for_cloning"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.get_kwargs_for_cloning">[docs]</a>    <span class="k">def</span> <span class="nf">get_kwargs_for_cloning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keep_status</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">only_db</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get common kwargs for calling Stack() for cloning.</span>

<span class="sd">        The point of this method is to reduce the number of places that we</span>
<span class="sd">        need to update when a kwarg to Stack.__init__() is modified. It</span>
<span class="sd">        is otherwise easy to forget an option and cause some unexpected</span>
<span class="sd">        error if this option is lost.</span>

<span class="sd">        Note:</span>
<span class="sd">        - This doesn&#39;t return the args(name, template) but only the kwargs.</span>
<span class="sd">        - We often want to start &#39;fresh&#39; so don&#39;t want to maintain the old</span>
<span class="sd">          status, action and status_reason.</span>
<span class="sd">        - We sometimes only want the DB attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;owner_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span><span class="p">,</span>
            <span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
            <span class="s">&#39;tenant_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">,</span>
            <span class="s">&#39;timeout_mins&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span><span class="p">,</span>
            <span class="s">&#39;disable_rollback&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span><span class="p">,</span>
            <span class="s">&#39;stack_user_project_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_user_project_id</span><span class="p">,</span>
            <span class="s">&#39;user_creds_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">,</span>
            <span class="s">&#39;nested_depth&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nested_depth</span><span class="p">,</span>
            <span class="s">&#39;convergence&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">convergence</span><span class="p">,</span>
            <span class="s">&#39;current_traversal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_traversal</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">keep_status</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                <span class="s">&#39;status_reason&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">only_db</span><span class="p">:</span>
            <span class="n">stack</span><span class="p">[</span><span class="s">&#39;parent_resource&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent_resource_name</span>
            <span class="n">stack</span><span class="p">[</span><span class="s">&#39;strict_validate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict_validate</span>

        <span class="k">return</span> <span class="n">stack</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.store&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.store"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.store">[docs]</a>    <span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Store the stack in the database and return its ID</span>
<span class="sd">        If self.id is set, we update the existing stack.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs_for_cloning</span><span class="p">(</span><span class="n">keep_status</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">only_db</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">s</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup_name</span><span class="p">()</span> <span class="k">if</span> <span class="n">backup</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="n">s</span><span class="p">[</span><span class="s">&#39;backup&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">backup</span>
        <span class="n">s</span><span class="p">[</span><span class="s">&#39;updated_at&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">s</span><span class="p">[</span><span class="s">&#39;raw_template_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="p">[</span><span class="s">&#39;raw_template_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span>
        <span class="c"># name inconsistencies</span>
        <span class="n">s</span><span class="p">[</span><span class="s">&#39;tenant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;tenant_id&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;tenant_id&#39;</span><span class="p">]</span>
        <span class="n">s</span><span class="p">[</span><span class="s">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;timeout_mins&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;timeout_mins&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">update_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">:</span>
                <span class="c"># Create a context containing a trust_id and trustor_user_id</span>
                <span class="c"># if trusts are enabled</span>
                <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">deferred_auth_method</span> <span class="o">==</span> <span class="s">&#39;trusts&#39;</span><span class="p">:</span>
                    <span class="n">keystone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;keystone&#39;</span><span class="p">)</span>
                    <span class="n">trust_ctx</span> <span class="o">=</span> <span class="n">keystone</span><span class="o">.</span><span class="n">create_trust_context</span><span class="p">()</span>
                    <span class="n">new_creds</span> <span class="o">=</span> <span class="n">ucreds_object</span><span class="o">.</span><span class="n">UserCreds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">trust_ctx</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_creds</span> <span class="o">=</span> <span class="n">ucreds_object</span><span class="o">.</span><span class="n">UserCreds</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
                <span class="n">s</span><span class="p">[</span><span class="s">&#39;user_creds_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_creds</span><span class="o">.</span><span class="n">id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span> <span class="o">=</span> <span class="n">new_creds</span><span class="o">.</span><span class="n">id</span>

            <span class="n">new_s</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">new_s</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="n">new_s</span><span class="o">.</span><span class="n">created_at</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
            <span class="n">stack_tag_object</span><span class="o">.</span><span class="n">StackTagList</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_param_stackid</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
</div>
    <span class="k">def</span> <span class="nf">_backup_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">*&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

<div class="viewcode-block" id="Stack.identifier"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.identifier">[docs]</a>    <span class="k">def</span> <span class="nf">identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return an identifier for this stack.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">identifier</span><span class="o">.</span><span class="n">HeatIdentifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return an iterator over the resource names.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return the number of resources.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the resource with the specified name.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

<div class="viewcode-block" id="Stack.add_resource"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.add_resource">[docs]</a>    <span class="k">def</span> <span class="nf">add_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Insert the given resource into the stack.&#39;&#39;&#39;</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">t</span>
        <span class="n">resource</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">reparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="p">)</span>
        <span class="n">resource</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">definition</span>
        <span class="n">resource</span><span class="o">.</span><span class="n">reparse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">resource</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">resource</span><span class="o">.</span><span class="n">INIT</span><span class="p">:</span>
            <span class="n">resource</span><span class="o">.</span><span class="n">_store</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Stack.remove_resource"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.remove_resource">[docs]</a>    <span class="k">def</span> <span class="nf">remove_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Remove the resource with the specified name.&#39;&#39;&#39;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">remove_resource</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Determine whether the stack contains the specified resource.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compare two Stacks for equality.</span>

<span class="sd">        Stacks are considered equal only if they are identical.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="ow">is</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a human-readable string representation of the stack.&#39;&#39;&#39;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;Stack &quot;</span><span class="si">%s</span><span class="s">&quot; [</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encodeutils</span><span class="o">.</span><span class="n">safe_encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a human-readable string representation of the stack.&#39;&#39;&#39;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;Stack &quot;</span><span class="si">%s</span><span class="s">&quot; [</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encodeutils</span><span class="o">.</span><span class="n">safe_encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<div class="viewcode-block" id="Stack.resource_by_refid"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.resource_by_refid">[docs]</a>    <span class="k">def</span> <span class="nf">resource_by_refid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refid</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the resource in this stack with the specified</span>
<span class="sd">        refid, or None if not found</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">INIT</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">RESUME</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">RESUME</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">),</span>
                    <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">))</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">FnGetRefId</span><span class="p">()</span> <span class="o">==</span> <span class="n">refid</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span>
</div>
<div class="viewcode-block" id="Stack.register_access_allowed_handler"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.register_access_allowed_handler">[docs]</a>    <span class="k">def</span> <span class="nf">register_access_allowed_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credential_id</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Register a function which determines whether the credentials with</span>
<span class="sd">        a give ID can have access to a named resource.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="nb">callable</span><span class="p">(</span><span class="n">handler</span><span class="p">),</span> <span class="s">&#39;Handler is not callable&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_access_allowed_handlers</span><span class="p">[</span><span class="n">credential_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
</div>
<div class="viewcode-block" id="Stack.access_allowed"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.access_allowed">[docs]</a>    <span class="k">def</span> <span class="nf">access_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credential_id</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns True if the credential_id is authorised to access the</span>
<span class="sd">        resource with the specified resource_name.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
            <span class="c"># this also triggers lazy-loading of resources</span>
            <span class="c"># so is required for register_access_allowed_handler</span>
            <span class="c"># to be called</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_access_allowed_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">credential_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">handler</span> <span class="ow">and</span> <span class="n">handler</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.validate&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.validate"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Validates the template.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># TODO(sdake) Should return line number of invalid reference</span>

        <span class="c"># validate overall template (top-level structure)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="c"># Validate parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                 <span class="n">validate_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strict_validate</span><span class="p">)</span>

        <span class="c"># Validate Parameter Groups</span>
        <span class="n">parameter_groups</span> <span class="o">=</span> <span class="n">param_groups</span><span class="o">.</span><span class="n">ParameterGroups</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="n">parameter_groups</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>

        <span class="c"># Validate types of sections in ResourceDefinitions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">validate_resource_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c"># Check duplicate names between parameters and resources</span>
        <span class="n">dup_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">dup_names</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Duplicate names </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">dup_names</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Duplicate names </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">dup_names</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">HeatException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">ex</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&quot;Exception: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">encodeutils</span><span class="o">.</span><span class="n">safe_decode</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Value&#39;</span><span class="p">):</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Each Output must contain &#39;</span>
                                <span class="s">&#39;a Value key.&#39;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
                <span class="n">function</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Value&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Output validation error: &#39;</span>
                            <span class="s">&#39;Outputs must contain Output. &#39;</span>
                            <span class="s">&#39;Found a [</span><span class="si">%s</span><span class="s">] instead&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Output validation error: &#39;</span>
                           <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Stack.requires_deferred_auth"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.requires_deferred_auth">[docs]</a>    <span class="k">def</span> <span class="nf">requires_deferred_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns whether this stack may need to perform API requests</span>
<span class="sd">        during its lifecycle using the configured deferred authentication</span>
<span class="sd">        method.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">requires_deferred_auth</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.state_set&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.state_set"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.state_set">[docs]</a>    <span class="k">def</span> <span class="nf">state_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the stack state in the database.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Invalid action </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUSES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Invalid status </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="n">reason</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">stack</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">update_and_save</span><span class="p">({</span><span class="s">&#39;action&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                                   <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                                   <span class="s">&#39;status_reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">})</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Stack </span><span class="si">%(action)s</span><span class="s"> </span><span class="si">%(status)s</span><span class="s"> (</span><span class="si">%(name)s</span><span class="s">): &#39;</span>
                         <span class="s">&#39;</span><span class="si">%(reason)s</span><span class="s">&#39;</span><span class="p">),</span>
                     <span class="p">{</span><span class="s">&#39;action&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                      <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                      <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                      <span class="s">&#39;reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">})</span>
            <span class="n">notification</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Stack.state"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.state">[docs]</a>    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns state, tuple of action, status.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Stack.timeout_secs"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.timeout_secs">[docs]</a>    <span class="k">def</span> <span class="nf">timeout_secs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the stack action timeout in seconds.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">stack_action_timeout</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span> <span class="o">*</span> <span class="mi">60</span>
</div>
<div class="viewcode-block" id="Stack.preview_resources"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.preview_resources">[docs]</a>    <span class="k">def</span> <span class="nf">preview_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Preview the stack with all of the resources.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">resource</span><span class="o">.</span><span class="n">preview</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">resource</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()]</span>
</div>
    <span class="k">def</span> <span class="nf">_store_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">r</span><span class="o">.</span><span class="n">INIT</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">_store</span><span class="p">()</span>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.create&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.create"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create the stack and all of the resources.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">rollback</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_store_resources</span><span class="p">()</span>

        <span class="n">creator</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack_task</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">post_func</span><span class="o">=</span><span class="n">rollback</span><span class="p">,</span>
            <span class="n">error_wait_time</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">error_wait_time</span><span class="p">)</span>
        <span class="n">creator</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">())</span>
</div>
    <span class="k">def</span> <span class="nf">_adopt_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adopt_stack_data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resources&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s">&#39;resource_data&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;resource_data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;resources&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">name</span><span class="p">)}</span>

    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Stack.stack_task"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.stack_task">[docs]</a>    <span class="k">def</span> <span class="nf">stack_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">post_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">error_wait_time</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">aggregate_exceptions</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A task to perform an action on the stack and all of the resources</span>
<span class="sd">        in forward or reverse dependency order as specified by reverse</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lifecycle_plugin_utils</span><span class="o">.</span><span class="n">do_pre_ops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                                              <span class="bp">None</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="k">else</span>
                           <span class="s">&#39;Failed stack pre-ops: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">post_func</span><span class="p">):</span>
                <span class="n">post_func</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
                       <span class="s">&#39;Stack </span><span class="si">%s</span><span class="s"> started&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>

        <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="s">&#39;Stack </span><span class="si">%s</span><span class="s"> completed successfully&#39;</span> <span class="o">%</span> <span class="n">action</span>

        <span class="k">def</span> <span class="nf">resource_action</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="c"># Find e.g resource.create and call it</span>
            <span class="n">action_l</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">action_l</span><span class="p">)</span>

            <span class="c"># If a local _$action_kwargs function exists, call it to get the</span>
            <span class="c"># action specific argument list, otherwise an empty arg list</span>
            <span class="n">handle_kwargs</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                    <span class="s">&#39;_</span><span class="si">%s</span><span class="s">_kwargs&#39;</span> <span class="o">%</span> <span class="n">action_l</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">{})</span>
            <span class="k">return</span> <span class="n">handle</span><span class="p">(</span><span class="o">**</span><span class="n">handle_kwargs</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>

        <span class="n">action_task</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">DependencyTaskGroup</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span>
            <span class="n">resource_action</span><span class="p">,</span>
            <span class="n">reverse</span><span class="p">,</span>
            <span class="n">error_wait_time</span><span class="o">=</span><span class="n">error_wait_time</span><span class="p">,</span>
            <span class="n">aggregate_exceptions</span><span class="o">=</span><span class="n">aggregate_exceptions</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">action_task</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> timed out&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="c"># We use a catch-all here to ensure any raised exceptions</span>
            <span class="c"># make the stack fail. This is necessary for when</span>
            <span class="c"># aggregate_exceptions is false, as in that case we don&#39;t get</span>
            <span class="c"># ExceptionGroup, but the raw exception.</span>
            <span class="c"># see scheduler.py line 395-399</span>
            <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s">&#39;Resource </span><span class="si">%s</span><span class="s"> failed: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">stack_status</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">post_func</span><span class="p">):</span>
            <span class="n">post_func</span><span class="p">()</span>
        <span class="n">lifecycle_plugin_utils</span><span class="o">.</span><span class="n">do_post_ops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
                                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">))</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.check&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.check"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.check">[docs]</a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">checker</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_task</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK</span><span class="p">,</span>
                                       <span class="n">post_func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">supports_check_action</span><span class="p">,</span>
                                       <span class="n">aggregate_exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">checker</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Stack.supports_check_action"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.supports_check_action">[docs]</a>    <span class="k">def</span> <span class="nf">supports_check_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">is_supported</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">&#39;nested&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">nested</span><span class="p">()</span><span class="o">.</span><span class="n">supports_check_action</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">&#39;handle_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="n">supported</span> <span class="o">=</span> <span class="p">[</span><span class="n">is_supported</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">supported</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;. &#39;</span><span class="si">%s</span><span class="s">&#39; not fully supported (see resources)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">+</span> <span class="n">msg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CHECK</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">supported</span><span class="p">)</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack._backup_stack&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_backup_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">create_if_missing</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get a Stack containing any in-progress resources from the previous</span>
<span class="sd">        stack state prior to an update.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">get_by_name_and_owner_id</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_backup_name</span><span class="p">(),</span>
            <span class="n">owner_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Loaded existing backup stack&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">create_if_missing</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs_for_cloning</span><span class="p">()</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;owner_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">),</span>
                              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">prev</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">backup</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Created new backup stack&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">prev</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.adopt&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.adopt"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.adopt">[docs]</a>    <span class="k">def</span> <span class="nf">adopt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Adopt a stack (create stack with all the existing resources).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">rollback</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADOPT</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">):</span>
                <span class="c"># enter the same flow as abandon and just delete the stack</span>
                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">abandon_in_progress</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">,</span> <span class="n">abandon</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">creator</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack_task</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ADOPT</span><span class="p">,</span>
            <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">post_func</span><span class="o">=</span><span class="n">rollback</span><span class="p">)</span>
        <span class="n">creator</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">())</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.update&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.update"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newstack</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compare the current stack with newstack,</span>
<span class="sd">        and where necessary create/update/delete the resources until</span>
<span class="sd">        this stack aligns with newstack.</span>

<span class="sd">        Note update of existing stack resources depends on update</span>
<span class="sd">        being implemented in the underlying resource types</span>

<span class="sd">        Update will fail if it exceeds the specified timeout. The default is</span>
<span class="sd">        60 minutes, set in the constructor</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">updater</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_task</span><span class="p">,</span> <span class="n">newstack</span><span class="p">,</span>
                                       <span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">)</span>
        <span class="n">updater</span><span class="p">()</span>
</div>
    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Stack.update_task"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.update_task">[docs]</a>    <span class="k">def</span> <span class="nf">update_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newstack</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RESTORE</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&quot;Unexpected action </span><span class="si">%s</span><span class="s"> passed to update!&quot;</span><span class="p">),</span> <span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                           <span class="s">&quot;Invalid action </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">lifecycle_plugin_utils</span><span class="o">.</span><span class="n">do_pre_ops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                                              <span class="n">newstack</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="k">else</span>
                           <span class="s">&#39;Failed stack pre-ops: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Starting update rollback for </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                               <span class="s">&#39;State invalid for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span>
                       <span class="s">&#39;Stack </span><span class="si">%s</span><span class="s"> started&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">:</span>
            <span class="c"># Oldstack is useless when the action is not UPDATE , so we don&#39;t</span>
            <span class="c"># need to build it, this can avoid some unexpected errors.</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kwargs_for_cloning</span><span class="p">()</span>
            <span class="n">oldstack</span> <span class="o">=</span> <span class="n">Stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">),</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">backup_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup_stack</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">update_task</span> <span class="o">=</span> <span class="n">update</span><span class="o">.</span><span class="n">StackUpdate</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">newstack</span><span class="p">,</span> <span class="n">backup_stack</span><span class="p">,</span>
                <span class="n">rollback</span><span class="o">=</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">,</span>
                <span class="n">error_wait_time</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">error_wait_time</span><span class="p">)</span>
            <span class="n">updater</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="n">update_task</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">env</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">disable_rollback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">timeout_mins</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_param_stackid</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">tags</span>
            <span class="k">if</span> <span class="n">newstack</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                <span class="n">stack_tag_object</span><span class="o">.</span><span class="n">StackTagList</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                  <span class="n">newstack</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack_tag_object</span><span class="o">.</span><span class="n">StackTagList</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">updater</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">())</span>
                <span class="k">yield</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">updater</span><span class="o">.</span><span class="n">step</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">event</span><span class="o">.</span><span class="n">ready</span><span class="p">():</span>
                        <span class="k">yield</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">message</span> <span class="o">==</span> <span class="n">rpc_api</span><span class="o">.</span><span class="n">THREAD_CANCEL</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">ForcedCancel</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reset_dependencies</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s">&#39;Stack successfully updated&#39;</span>
            <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">RESTORE</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s">&#39;Stack successfully restored&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s">&#39;Stack rollback completed&#39;</span>
            <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span>

        <span class="k">except</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s">&#39;Timed out&#39;</span>
        <span class="k">except</span> <span class="n">ForcedCancel</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">:</span>
                <span class="n">update_task</span><span class="o">.</span><span class="n">updater</span><span class="o">.</span><span class="n">cancel_all</span><span class="p">()</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_task</span><span class="p">(</span><span class="n">oldstack</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">:</span>
                <span class="c"># If rollback is enabled, we do another update, with the</span>
                <span class="c"># existing template, so we roll back to the original state</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_task</span><span class="p">(</span><span class="n">oldstack</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">)</span>
                    <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Deleting backup stack&#39;</span><span class="p">)</span>
            <span class="n">backup_stack</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">backup</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="c"># flip the template to the newstack values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">newstack</span><span class="o">.</span><span class="n">t</span>
            <span class="n">template_outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">OUTPUTS</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_static_data</span><span class="p">(</span><span class="n">template_outputs</span><span class="p">)</span>

        <span class="c"># Don&#39;t use state_set to do only one update query and avoid race</span>
        <span class="c"># condition with the COMPLETE status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">stack_status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="n">reason</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
        <span class="n">lifecycle_plugin_utils</span><span class="o">.</span><span class="n">do_post_ops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                                           <span class="n">newstack</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
                                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">))</span>

        <span class="n">notification</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_delete_backup_stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
        <span class="c"># Delete resources in the backup stack referred to by &#39;stack&#39;</span>

        <span class="k">def</span> <span class="nf">failed</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">child</span><span class="o">.</span><span class="n">CREATE</span> <span class="ow">and</span>
                    <span class="n">child</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">child</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">backup_res</span> <span class="ow">in</span> <span class="n">stack</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c"># If UpdateReplace is failed, we must restore backup_res</span>
            <span class="c"># to existing_stack in case of it may have dependencies in</span>
            <span class="c"># these stacks. curr_res is the resource that just</span>
            <span class="c"># created and failed, so put into the stack to delete anyway.</span>
            <span class="n">backup_res_id</span> <span class="o">=</span> <span class="n">backup_res</span><span class="o">.</span><span class="n">resource_id</span>
            <span class="n">curr_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">backup_res_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">curr_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">curr_res_id</span> <span class="o">=</span> <span class="n">curr_res</span><span class="o">.</span><span class="n">resource_id</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">failed</span><span class="p">(</span><span class="n">child</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">curr_res</span><span class="p">])</span> <span class="ow">or</span>
                        <span class="n">curr_res</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span>
                        <span class="p">(</span><span class="n">curr_res</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">curr_res</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">)):</span>
                    <span class="c"># If child resource failed to update, curr_res</span>
                    <span class="c"># should be replaced to resolve dependencies. But this</span>
                    <span class="c"># is not fundamental solution. If there are update</span>
                    <span class="c"># failer and success resources in the children, cannot</span>
                    <span class="c"># delete the stack.</span>
                    <span class="c"># Stack class owns dependencies as set of resource&#39;s</span>
                    <span class="c"># objects, so we switch members of the resource that is</span>
                    <span class="c"># needed to delete it.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">backup_res_id</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">backup_res</span><span class="o">.</span><span class="n">properties</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">curr_res_id</span>
                    <span class="n">stack</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">curr_res</span><span class="o">.</span><span class="n">properties</span>

        <span class="n">stack</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">backup</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_try_get_user_creds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_creds_id</span><span class="p">):</span>
        <span class="c"># There are cases where the user_creds cannot be returned</span>
        <span class="c"># due to credentials truncated when being saved to DB.</span>
        <span class="c"># Ignore this error instead of blocking stack deletion.</span>
        <span class="n">user_creds</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_creds</span> <span class="o">=</span> <span class="n">ucreds_object</span><span class="o">.</span><span class="n">UserCreds</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">user_creds</span>

    <span class="k">def</span> <span class="nf">_delete_credentials</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack_status</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">abandon</span><span class="p">):</span>
        <span class="c"># Cleanup stored user_creds so they aren&#39;t accessible via</span>
        <span class="c"># the soft-deleted stack which remains in the DB</span>
        <span class="c"># The stack_status and reason passed in are current values, which</span>
        <span class="c"># may get rewritten and returned from this method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">:</span>
            <span class="n">user_creds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_get_user_creds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">)</span>
            <span class="c"># If we created a trust, delete it</span>
            <span class="k">if</span> <span class="n">user_creds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">trust_id</span> <span class="o">=</span> <span class="n">user_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;trust_id&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">trust_id</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c"># If the trustor doesn&#39;t match the context user the</span>
                        <span class="c"># we have to use the stored context to cleanup the</span>
                        <span class="c"># trust, as although the user evidently has</span>
                        <span class="c"># permission to delete the stack, they don&#39;t have</span>
                        <span class="c"># rights to delete the trust unless an admin</span>
                        <span class="n">trustor_id</span> <span class="o">=</span> <span class="n">user_creds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;trustor_user_id&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">user_id</span> <span class="o">!=</span> <span class="n">trustor_id</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Context user_id doesn&#39;t match &quot;</span>
                                      <span class="s">&quot;trustor, using stored context&quot;</span><span class="p">)</span>
                            <span class="n">sc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stored_context</span><span class="p">()</span>
                            <span class="n">sc</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;keystone&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete_trust</span><span class="p">(</span>
                                <span class="n">trust_id</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;keystone&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete_trust</span><span class="p">(</span>
                                <span class="n">trust_id</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                        <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
                        <span class="n">reason</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;Error deleting trust: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                  <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

            <span class="c"># Delete the stored credentials</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ucreds_object</span><span class="o">.</span><span class="n">UserCreds</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&quot;Tried to delete user_creds that do not exist &quot;</span>
                             <span class="s">&quot;(stack=</span><span class="si">%(stack)s</span><span class="s"> user_creds_id=</span><span class="si">%(uc)s</span><span class="s">)&quot;</span><span class="p">),</span>
                         <span class="p">{</span><span class="s">&#39;stack&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&#39;uc&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span><span class="p">})</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">user_creds_id</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&quot;Tried to store a stack that does not exist </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="c"># If the stack has a domain project, delete it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_user_project_id</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">abandon</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">keystone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;keystone&#39;</span><span class="p">)</span>
                <span class="n">keystone</span><span class="o">.</span><span class="n">delete_stack_domain_project</span><span class="p">(</span>
                    <span class="n">project_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_user_project_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="s">&quot;Error deleting project: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stack_status</span><span class="p">,</span> <span class="n">reason</span>

    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.delete&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.delete"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">DELETE</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">abandon</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Delete all of the resources, and then the stack itself.</span>
<span class="sd">        The action parameter is used to differentiate between a user</span>
<span class="sd">        initiated delete and an automatic stack rollback after a failed</span>
<span class="sd">        create, which amount to the same thing, but the states are recorded</span>
<span class="sd">        differently.</span>

<span class="sd">        Note abandon is a delete where all resources have been set to a</span>
<span class="sd">        RETAIN deletion policy, but we also don&#39;t want to delete anything</span>
<span class="sd">        required for those resources, e.g the stack_user_project.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROLLBACK</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&quot;Unexpected action </span><span class="si">%s</span><span class="s"> passed to delete!&quot;</span><span class="p">),</span> <span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                           <span class="s">&quot;Invalid action </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="s">&#39;Stack </span><span class="si">%s</span><span class="s"> completed successfully&#39;</span> <span class="o">%</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">,</span> <span class="s">&#39;Stack </span><span class="si">%s</span><span class="s"> started&#39;</span> <span class="o">%</span>
                       <span class="n">action</span><span class="p">)</span>

        <span class="n">backup_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backup_stack</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">backup_stack</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_delete_backup_stack</span><span class="p">(</span><span class="n">backup_stack</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">backup_stack</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">backup_stack</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">:</span>
                <span class="n">errs</span> <span class="o">=</span> <span class="n">backup_stack</span><span class="o">.</span><span class="n">status_reason</span>
                <span class="n">failure</span> <span class="o">=</span> <span class="s">&#39;Error deleting backup resources: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">errs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                               <span class="s">&#39;Failed to </span><span class="si">%s</span><span class="s"> : </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">failure</span><span class="p">))</span>
                <span class="k">return</span>

        <span class="n">snapshots</span> <span class="o">=</span> <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_snapshot</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
            <span class="n">snapshot_object</span><span class="o">.</span><span class="n">Snapshot</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">backup</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lifecycle_plugin_utils</span><span class="o">.</span><span class="n">do_pre_ops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                                                  <span class="bp">None</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                               <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="k">else</span>
                               <span class="s">&#39;Failed stack pre-ops: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="n">action_task</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">DependencyTaskGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">,</span>
                                                    <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">destroy</span><span class="p">,</span>
                                                    <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="n">action_task</span><span class="p">)(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s">&#39;Resource </span><span class="si">%s</span><span class="s"> failed: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="n">stack_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> timed out&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

        <span class="c"># If the stack delete succeeded, this is not a backup stack and it&#39;s</span>
        <span class="c"># not a nested stack, we should delete the credentials</span>
        <span class="k">if</span> <span class="n">stack_status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">backup</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">owner_id</span><span class="p">:</span>
            <span class="n">stack_status</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_delete_credentials</span><span class="p">(</span><span class="n">stack_status</span><span class="p">,</span>
                                                            <span class="n">reason</span><span class="p">,</span>
                                                            <span class="n">abandon</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">stack_status</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&quot;Tried to delete stack that does not exist &quot;</span>
                         <span class="s">&quot;</span><span class="si">%s</span><span class="s"> &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">backup</span><span class="p">:</span>
            <span class="n">lifecycle_plugin_utils</span><span class="o">.</span><span class="n">do_post_ops</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span>
                                               <span class="bp">None</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
                                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">stack_status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
            <span class="c"># delete the stack</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stack_object</span><span class="o">.</span><span class="n">Stack</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&quot;Tried to delete stack that does not exist &quot;</span>
                             <span class="s">&quot;</span><span class="si">%s</span><span class="s"> &quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.suspend&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.suspend"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.suspend">[docs]</a>    <span class="k">def</span> <span class="nf">suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Suspend the stack, which invokes handle_suspend for all stack resources</span>
<span class="sd">        waits for all resources to become SUSPEND_COMPLETE then declares the</span>
<span class="sd">        stack SUSPEND_COMPLETE.</span>
<span class="sd">        Note the default implementation for all resources is to do nothing</span>
<span class="sd">        other than move to SUSPEND_COMPLETE, so the resources must implement</span>
<span class="sd">        handle_suspend for this to have any effect.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># No need to suspend if the stack has been suspended</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUSPEND</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> is already suspended&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">sus_task</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_task</span><span class="p">,</span>
                                        <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SUSPEND</span><span class="p">,</span>
                                        <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">sus_task</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">())</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.resume&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.resume"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.resume">[docs]</a>    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Resume the stack, which invokes handle_resume for all stack resources</span>
<span class="sd">        waits for all resources to become RESUME_COMPLETE then declares the</span>
<span class="sd">        stack RESUME_COMPLETE.</span>
<span class="sd">        Note the default implementation for all resources is to do nothing</span>
<span class="sd">        other than move to RESUME_COMPLETE, so the resources must implement</span>
<span class="sd">        handle_resume for this to have any effect.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># No need to resume if the stack has been resumed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RESUME</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> is already resumed&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">sus_task</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_task</span><span class="p">,</span>
                                        <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RESUME</span><span class="p">,</span>
                                        <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">sus_task</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">())</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.snapshot&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.snapshot"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Snapshot the stack, invoking handle_snapshot on all resources.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="n">sus_task</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack_task</span><span class="p">,</span>
                                        <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SNAPSHOT</span><span class="p">,</span>
                                        <span class="n">reverse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">sus_task</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_secs</span><span class="p">())</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.delete_snapshot&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.delete_snapshot"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.delete_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">delete_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Remove a snapshot from the backends.&#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">rsrc</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">):</span>
            <span class="n">snapshot_data</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">data</span>
            <span class="k">if</span> <span class="n">snapshot_data</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;resources&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="n">rsrc</span><span class="o">.</span><span class="n">delete_snapshot</span><span class="p">,</span> <span class="n">data</span><span class="p">)()</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.restore&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.restore"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.restore">[docs]</a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Restore the given snapshot, invoking handle_restore on all resources.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">tmpl</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;template&#39;</span><span class="p">],</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">defn</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">resource_definitions</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="n">rsrc</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">defn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">snapshot</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;resources&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">handle_restore</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rsrc</span><span class="p">,</span> <span class="s">&#39;handle_restore&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">handle_restore</span><span class="p">):</span>
                <span class="n">defn</span> <span class="o">=</span> <span class="n">handle_restore</span><span class="p">(</span><span class="n">defn</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">template</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">defn</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="n">newstack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span>
                                  <span class="n">timeout_mins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout_mins</span><span class="p">,</span>
                                  <span class="n">disable_rollback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">disable_rollback</span><span class="p">)</span>
        <span class="n">newstack</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">set_stack_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>

        <span class="n">updater</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_task</span><span class="p">,</span> <span class="n">newstack</span><span class="p">,</span>
                                       <span class="n">action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RESTORE</span><span class="p">)</span>
        <span class="n">updater</span><span class="p">()</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.output&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.output"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.output">[docs]</a>    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the value of the specified stack output.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Value&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">function</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s">&#39;error_msg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Stack.restart_resource"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.restart_resource">[docs]</a>    <span class="k">def</span> <span class="nf">restart_resource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        stop resource_name and all that depend on it</span>
<span class="sd">        start resource_name and all that depend on it</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="bp">self</span><span class="p">[</span><span class="n">resource_name</span><span class="p">]]</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">deps</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">destroy</span><span class="p">)()</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">failed</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&#39;Resource </span><span class="si">%(name)s</span><span class="s"> delete failed: </span><span class="si">%(ex)s</span><span class="s">&#39;</span><span class="p">),</span>
                          <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;ex&#39;</span><span class="p">:</span> <span class="n">ex</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">failed</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">.</span><span class="n">state_reset</span><span class="p">()</span>
                    <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">create</span><span class="p">)()</span>
                <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&#39;Resource </span><span class="si">%(name)s</span><span class="s"> create failed: &#39;</span>
                                      <span class="s">&#39;</span><span class="si">%(ex)s</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;ex&#39;</span><span class="p">:</span> <span class="n">ex</span><span class="p">})</span>
                    <span class="n">failed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span>
                              <span class="s">&#39;Resource restart aborted&#39;</span><span class="p">)</span>
        <span class="c"># TODO(asalkeld) if any of this fails we Should</span>
        <span class="c"># restart the whole stack</span>
</div>
<div class="viewcode-block" id="Stack.get_availability_zones"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.get_availability_zones">[docs]</a>    <span class="k">def</span> <span class="nf">get_availability_zones</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nova</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;nova&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zones</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_zones</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">zone</span><span class="o">.</span><span class="n">zoneName</span> <span class="k">for</span> <span class="n">zone</span> <span class="ow">in</span>
                <span class="n">nova</span><span class="o">.</span><span class="n">availability_zones</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">detailed</span><span class="o">=</span><span class="bp">False</span><span class="p">)]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zones</span>
</div>
<div class="viewcode-block" id="Stack.set_stack_user_project_id"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.set_stack_user_project_id">[docs]</a>    <span class="k">def</span> <span class="nf">set_stack_user_project_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack_user_project_id</span> <span class="o">=</span> <span class="n">project_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.create_stack_user_project_id&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.create_stack_user_project_id"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.create_stack_user_project_id">[docs]</a>    <span class="k">def</span> <span class="nf">create_stack_user_project_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span>
            <span class="s">&#39;keystone&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create_stack_domain_project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_stack_user_project_id</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>
</div>
    <span class="nd">@profiler.trace</span><span class="p">(</span><span class="s">&#39;Stack.prepare_abandon&#39;</span><span class="p">,</span> <span class="n">hide_args</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<div class="viewcode-block" id="Stack.prepare_abandon"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.prepare_abandon">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_abandon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="s">&#39;environment&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">user_env_as_dict</span><span class="p">(),</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="s">&#39;template&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
            <span class="s">&#39;resources&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">((</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">prepare_abandon</span><span class="p">())</span>
                              <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="s">&#39;project_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">,</span>
            <span class="s">&#39;stack_user_project_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_user_project_id</span>
        <span class="p">}</span>
</div>
<div class="viewcode-block" id="Stack.resolve_static_data"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.resolve_static_data">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_static_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snippet</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snippet</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="n">encodeutils</span><span class="o">.</span><span class="n">safe_decode</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="Stack.resolve_runtime_data"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.resolve_runtime_data">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_runtime_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snippet</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DEPRECATED. Use heat.engine.function.resolve() instead.&quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Stack.resolve_runtime_data() is deprecated. &#39;</span>
                      <span class="s">&#39;Use heat.engine.function.resolve() instead&#39;</span><span class="p">,</span>
                      <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">function</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">snippet</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Stack.reset_resource_attributes"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.stack.html#heat.engine.stack.Stack.reset_resource_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">reset_resource_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># nothing is cached if no resources exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c"># a change in some resource may have side-effects in the attributes</span>
        <span class="c"># of other resources, so ensure that attributes are re-calculated</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">res</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">reset_resolved_values</span><span class="p">()</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li><a href="../../../raxdox/index.html">Supported Resources</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012,2015 Rackspace.
      Last updated on Mon Apr 13 21:08:05 2015, commit 58cb011.
    </div>
  </body>
</html>
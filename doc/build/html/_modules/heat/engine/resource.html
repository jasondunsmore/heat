<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>heat.engine.resource &mdash; Supported Resources</title>
    
    <link rel="stylesheet" href="../../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2015.2.0.dev378',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Supported Resources" href="../../../raxdox/index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../../../raxdox/index.html">Supported Resources</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for heat.engine.resource</h1><div class="highlight"><pre>
<span class="c">#</span>
<span class="c">#    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span>
<span class="c">#    not use this file except in compliance with the License. You may obtain</span>
<span class="c">#    a copy of the License at</span>
<span class="c">#</span>
<span class="c">#         http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c">#</span>
<span class="c">#    Unless required by applicable law or agreed to in writing, software</span>
<span class="c">#    distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c">#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span>
<span class="c">#    License for the specific language governing permissions and limitations</span>
<span class="c">#    under the License.</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="kn">as</span> <span class="nn">dt</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">from</span> <span class="nn">oslo_config</span> <span class="kn">import</span> <span class="n">cfg</span>
<span class="kn">from</span> <span class="nn">oslo_log</span> <span class="kn">import</span> <span class="n">log</span> <span class="k">as</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">encodeutils</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">excutils</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">exception</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LE</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LI</span>
<span class="kn">from</span> <span class="nn">heat.common.i18n</span> <span class="kn">import</span> <span class="n">_LW</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">identifier</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">short_id</span>
<span class="kn">from</span> <span class="nn">heat.common</span> <span class="kn">import</span> <span class="n">timeutils</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">attributes</span>
<span class="kn">from</span> <span class="nn">heat.engine.cfn</span> <span class="kn">import</span> <span class="n">template</span> <span class="k">as</span> <span class="n">cfn_tmpl</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">environment</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">function</span>
<span class="kn">from</span> <span class="nn">heat.engine.hot</span> <span class="kn">import</span> <span class="n">template</span> <span class="k">as</span> <span class="n">hot_tmpl</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">properties</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">rsrc_defn</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">scheduler</span>
<span class="kn">from</span> <span class="nn">heat.engine</span> <span class="kn">import</span> <span class="n">support</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">resource</span> <span class="k">as</span> <span class="n">resource_objects</span>
<span class="kn">from</span> <span class="nn">heat.objects</span> <span class="kn">import</span> <span class="n">resource_data</span> <span class="k">as</span> <span class="n">resource_data_objects</span>
<span class="kn">from</span> <span class="nn">heat.rpc</span> <span class="kn">import</span> <span class="n">client</span> <span class="k">as</span> <span class="n">rpc_client</span>

<span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">import_opt</span><span class="p">(</span><span class="s">&#39;action_retry_limit&#39;</span><span class="p">,</span> <span class="s">&#39;heat.common.config&#39;</span><span class="p">)</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">datetime</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span>


<span class="k">def</span> <span class="nf">_register_class</span><span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_class</span><span class="p">):</span>
    <span class="n">resources</span><span class="o">.</span><span class="n">global_env</span><span class="p">()</span><span class="o">.</span><span class="n">register_class</span><span class="p">(</span><span class="n">resource_type</span><span class="p">,</span> <span class="n">resource_class</span><span class="p">)</span>


<div class="viewcode-block" id="UpdateReplace"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.UpdateReplace">[docs]</a><span class="k">class</span> <span class="nc">UpdateReplace</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Raised when resource update requires replacement.&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="o">=</span><span class="s">&#39;Unknown&#39;</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;The Resource </span><span class="si">%s</span><span class="s"> requires replacement.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">resource_name</span>
        <span class="nb">super</span><span class="p">(</span><span class="ne">Exception</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="NoActionRequired"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.NoActionRequired">[docs]</a><span class="k">class</span> <span class="nc">NoActionRequired</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="ResourceInError"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.ResourceInError">[docs]</a><span class="k">class</span> <span class="nc">ResourceInError</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">HeatException</span><span class="p">):</span>
    <span class="n">msg_fmt</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Went to status </span><span class="si">%(resource_status)s</span><span class="s"> &#39;</span>
                <span class="s">&#39;due to &quot;</span><span class="si">%(status_reason)s</span><span class="s">&quot;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_reason</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Unknown&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResourceInError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">status_reason</span><span class="o">=</span><span class="n">status_reason</span><span class="p">,</span>
                                              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ResourceUnknownStatus"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.ResourceUnknownStatus">[docs]</a><span class="k">class</span> <span class="nc">ResourceUnknownStatus</span><span class="p">(</span><span class="n">exception</span><span class="o">.</span><span class="n">HeatException</span><span class="p">):</span>
    <span class="n">msg_fmt</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%(result)s</span><span class="s"> - Unknown status </span><span class="si">%(resource_status)s</span><span class="s"> due to &#39;</span>
                <span class="s">&#39;&quot;</span><span class="si">%(status_reason)s</span><span class="s">&quot;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Resource failed&#39;</span><span class="p">),</span>
                 <span class="n">status_reason</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Unknown&#39;</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResourceUnknownStatus</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">status_reason</span><span class="o">=</span><span class="n">status_reason</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Resource"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource">[docs]</a><span class="k">class</span> <span class="nc">Resource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">ACTIONS</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">INIT</span><span class="p">,</span> <span class="n">CREATE</span><span class="p">,</span> <span class="n">DELETE</span><span class="p">,</span> <span class="n">UPDATE</span><span class="p">,</span> <span class="n">ROLLBACK</span><span class="p">,</span>
        <span class="n">SUSPEND</span><span class="p">,</span> <span class="n">RESUME</span><span class="p">,</span> <span class="n">ADOPT</span><span class="p">,</span> <span class="n">SNAPSHOT</span><span class="p">,</span> <span class="n">CHECK</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s">&#39;INIT&#39;</span><span class="p">,</span> <span class="s">&#39;CREATE&#39;</span><span class="p">,</span> <span class="s">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s">&#39;UPDATE&#39;</span><span class="p">,</span> <span class="s">&#39;ROLLBACK&#39;</span><span class="p">,</span>
        <span class="s">&#39;SUSPEND&#39;</span><span class="p">,</span> <span class="s">&#39;RESUME&#39;</span><span class="p">,</span> <span class="s">&#39;ADOPT&#39;</span><span class="p">,</span> <span class="s">&#39;SNAPSHOT&#39;</span><span class="p">,</span> <span class="s">&#39;CHECK&#39;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">STATUSES</span> <span class="o">=</span> <span class="p">(</span><span class="n">IN_PROGRESS</span><span class="p">,</span> <span class="n">FAILED</span><span class="p">,</span> <span class="n">COMPLETE</span>
                <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;IN_PROGRESS&#39;</span><span class="p">,</span> <span class="s">&#39;FAILED&#39;</span><span class="p">,</span> <span class="s">&#39;COMPLETE&#39;</span><span class="p">)</span>

    <span class="c"># If True, this resource must be created before it can be referenced.</span>
    <span class="n">strict_dependency</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c"># Resource implementation set this to the subset of resource properties</span>
    <span class="c"># supported for handle_update, used by update_template_diff_properties</span>
    <span class="n">update_allowed_properties</span> <span class="o">=</span> <span class="p">()</span>

    <span class="c"># Resource implementations set this to the name: description dictionary</span>
    <span class="c"># that describes the appropriate resource attributes</span>
    <span class="n">attributes_schema</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c"># If True, this resource may perform authenticated API requests</span>
    <span class="c"># throughout its lifecycle</span>
    <span class="n">requires_deferred_auth</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># Limit to apply to physical_resource_name() size reduction algorithm.</span>
    <span class="c"># If set to None no limit will be applied.</span>
    <span class="n">physical_resource_name_limit</span> <span class="o">=</span> <span class="mi">255</span>

    <span class="n">support_status</span> <span class="o">=</span> <span class="n">support</span><span class="o">.</span><span class="n">SupportStatus</span><span class="p">()</span>

    <span class="c"># Default name to use for calls to self.client()</span>
    <span class="n">default_client_name</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a new Resource of the appropriate class for its type.&#39;&#39;&#39;</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">definition</span><span class="p">,</span> <span class="n">rsrc_defn</span><span class="o">.</span><span class="n">ResourceDefinition</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cls</span> <span class="o">!=</span> <span class="n">Resource</span><span class="p">:</span>
            <span class="c"># Call is already for a subclass, so pass it through</span>
            <span class="n">ResourceClass</span> <span class="o">=</span> <span class="n">cls</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">heat.engine.resources</span> <span class="kn">import</span> <span class="n">template_resource</span>

            <span class="n">registry</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ResourceClass</span> <span class="o">=</span> <span class="n">registry</span><span class="o">.</span><span class="n">get_class</span><span class="p">(</span><span class="n">definition</span><span class="o">.</span><span class="n">resource_type</span><span class="p">,</span>
                                                   <span class="n">resource_name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">TemplateNotFound</span><span class="p">:</span>
                <span class="n">ResourceClass</span> <span class="o">=</span> <span class="n">template_resource</span><span class="o">.</span><span class="n">TemplateResource</span>
            <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">ResourceClass</span><span class="p">,</span> <span class="n">Resource</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Resource</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">ResourceClass</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">_validate_name</span><span class="p">(</span><span class="n">res_name</span><span class="p">):</span>
            <span class="k">if</span> <span class="s">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">res_name</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Resource name may not contain &quot;/&quot;&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>

        <span class="n">_validate_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="n">stack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">definition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reparse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">Attributes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">attributes_schema</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_attribute</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">abandon_in_progress</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># if the stack is being deleted, assume we&#39;ve already been deleted</span>
        <span class="k">if</span> <span class="n">stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="n">stack</span><span class="o">.</span><span class="n">DELETE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_client</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needed_by</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replaces</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replaced_by</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_template_id</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="o">.</span><span class="n">has_cache_data</span><span class="p">():</span>
            <span class="n">resource</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">db_resource_get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resource</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_load_data</span><span class="p">(</span><span class="n">resource</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.rpc_client"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.rpc_client">[docs]</a>    <span class="k">def</span> <span class="nf">rpc_client</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a client for making engine RPC calls.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_client</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_client</span> <span class="o">=</span> <span class="n">rpc_client</span><span class="o">.</span><span class="n">EngineClient</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpc_client</span>
</div>
    <span class="k">def</span> <span class="nf">_load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Load the resource state from its DB representation.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">nova_instance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">status_reason</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">uuid</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">resource_data_objects</span><span class="o">.</span><span class="n">ResourceData</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">resource</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">rsrc_metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">properties_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">created_at</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">updated_at</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">needed_by</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">needed_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requires</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">requires</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replaces</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">replaces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replaced_by</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">replaced_by</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_template_id</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">current_template_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stackref</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">stack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&quot;Need a reference to the Stack object&quot;</span>
        <span class="k">return</span> <span class="n">stack</span>

    <span class="nd">@stack.setter</span>
    <span class="k">def</span> <span class="nf">stack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stack</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stackref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.reparse"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.reparse">[docs]</a>    <span class="k">def</span> <span class="nf">reparse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties_schema</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Allow == comparison of two resources.&#39;&#39;&#39;</span>
        <span class="c"># For the purposes of comparison, we declare two resource objects</span>
        <span class="c"># equal if their names and parsed_templates are the same</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Resource</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">parsed_template</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">NotImplemented</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Allow != comparison of two resources.&#39;&#39;&#39;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="bp">NotImplemented</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DEPRECATED. use method metadata_get instead.&quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;metadata attribute is deprecated, &#39;</span>
                      <span class="s">&#39;use method metadata_get instead&#39;</span><span class="p">,</span>
                      <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_get</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="nd">@metadata.setter</span>
    <span class="k">def</span> <span class="nf">metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;DEPRECATED. use method metadata_set instead.&quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;metadata attribute is deprecated, &#39;</span>
                      <span class="s">&#39;use method metadata_set instead&#39;</span><span class="p">,</span>
                      <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_set</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.metadata_get"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.metadata_get">[docs]</a>    <span class="k">def</span> <span class="nf">metadata_get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refresh</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">refresh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">metadata</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;rsrc_metadata&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">rsrc_metadata</span>
        <span class="k">return</span> <span class="n">rs</span><span class="o">.</span><span class="n">rsrc_metadata</span>
</div>
<div class="viewcode-block" id="Resource.metadata_set"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.metadata_set">[docs]</a>    <span class="k">def</span> <span class="nf">metadata_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceNotAvailable</span><span class="p">(</span><span class="n">resource_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">update_and_save</span><span class="p">({</span><span class="s">&#39;rsrc_metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Resource.set_needed_by"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.set_needed_by">[docs]</a>    <span class="k">def</span> <span class="nf">set_needed_by</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">db_rsrc</span><span class="p">,</span> <span class="n">needed_by</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">db_rsrc</span><span class="p">:</span>
            <span class="n">db_rsrc</span><span class="o">.</span><span class="n">update_and_save</span><span class="p">(</span>
                <span class="p">{</span><span class="s">&#39;needed_by&#39;</span><span class="p">:</span> <span class="n">needed_by</span><span class="p">}</span>
            <span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Resource.set_requires"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.set_requires">[docs]</a>    <span class="k">def</span> <span class="nf">set_requires</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">db_rsrc</span><span class="p">,</span> <span class="n">requires</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">db_rsrc</span><span class="p">:</span>
            <span class="n">db_rsrc</span><span class="o">.</span><span class="n">update_and_save</span><span class="p">(</span>
                <span class="p">{</span><span class="s">&#39;requires&#39;</span><span class="p">:</span> <span class="n">requires</span><span class="p">}</span>
            <span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_break_if_required</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Block the resource until the hook is cleared if there is one.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">matches_hook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                            <span class="n">_</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%(a)s</span><span class="s"> paused until Hook </span><span class="si">%(h)s</span><span class="s"> is cleared&quot;</span><span class="p">)</span>
                            <span class="o">%</span> <span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span> <span class="s">&#39;h&#39;</span><span class="p">:</span> <span class="n">hook</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Reached hook on </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clear_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                    <span class="s">&quot;Failure occured while waiting.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.has_hook"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.has_hook">[docs]</a>    <span class="k">def</span> <span class="nf">has_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
        <span class="c"># Clear the cache to make sure the data is up to date:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;True&quot;</span>
</div>
<div class="viewcode-block" id="Resource.trigger_hook"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.trigger_hook">[docs]</a>    <span class="k">def</span> <span class="nf">trigger_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">(</span><span class="n">hook</span><span class="p">,</span> <span class="s">&quot;True&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.clear_hook"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.clear_hook">[docs]</a>    <span class="k">def</span> <span class="nf">clear_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hook</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_delete</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.type"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.type">[docs]</a>    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">resource_type</span>
</div>
<div class="viewcode-block" id="Resource.has_interface"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.has_interface">[docs]</a>    <span class="k">def</span> <span class="nf">has_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check to see if this resource is either mapped to resource_type</span>
<span class="sd">        or is a &quot;resource_type&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">resource_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">get_resource_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ri</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">resource_type</span>
</div>
<div class="viewcode-block" id="Resource.implementation_signature"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.implementation_signature">[docs]</a>    <span class="k">def</span> <span class="nf">implementation_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a tuple defining the implementation.</span>

<span class="sd">        This should be broken down into a definition and an</span>
<span class="sd">        implementation version.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">support_status</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.identifier"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.identifier">[docs]</a>    <span class="k">def</span> <span class="nf">identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return an identifier for this resource.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">identifier</span><span class="o">.</span><span class="n">ResourceIdentifier</span><span class="p">(</span><span class="n">resource_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                             <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">identifier</span><span class="p">())</span>
</div>
<div class="viewcode-block" id="Resource.parsed_template"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.parsed_template">[docs]</a>    <span class="k">def</span> <span class="nf">parsed_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the parsed template data for the resource. May be limited to</span>
<span class="sd">        only one section of the data, in which case a default value may also</span>
<span class="sd">        be supplied.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">default</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">function</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.frozen_definition"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.frozen_definition">[docs]</a>    <span class="k">def</span> <span class="nf">frozen_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;properties&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">freeze</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.update_template_diff"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.update_template_diff">[docs]</a>    <span class="k">def</span> <span class="nf">update_template_diff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the difference between the before and after json snippets. If</span>
<span class="sd">        something has been removed in after which exists in before we set it to</span>
<span class="sd">        None.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># Create a set containing the keys in both current and update template</span>
        <span class="n">template_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="n">before</span><span class="p">))</span>
        <span class="n">template_keys</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">(</span><span class="n">after</span><span class="p">)))</span>

        <span class="c"># Create a set of keys which differ (or are missing/added)</span>
        <span class="n">changed_keys_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">template_keys</span>
                                <span class="k">if</span> <span class="n">before</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="n">after</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)])</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">after</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">changed_keys_set</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.update_template_diff_properties"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.update_template_diff_properties">[docs]</a>    <span class="k">def</span> <span class="nf">update_template_diff_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns the changed Properties between the before and after properties.</span>
<span class="sd">        If any property having immutable as True is updated,</span>
<span class="sd">        raises NotSupported error.</span>
<span class="sd">        If any properties have changed which are not in</span>
<span class="sd">        update_allowed_properties, raises UpdateReplace.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">update_allowed_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_allowed_properties</span><span class="p">)</span>
        <span class="n">immutable_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">psk</span><span class="p">,</span> <span class="n">psv</span><span class="p">)</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">props</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">psv</span><span class="o">.</span><span class="n">update_allowed</span><span class="p">():</span>
                <span class="n">update_allowed_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">psk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">psv</span><span class="o">.</span><span class="n">immutable</span><span class="p">():</span>
                <span class="n">immutable_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">psk</span><span class="p">)</span>

        <span class="c"># Create a set of keys which differ (or are missing/added)</span>
        <span class="n">changed_properties_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">after_props</span>
                                     <span class="k">if</span> <span class="n">before_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">!=</span>
                                     <span class="n">after_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

        <span class="c"># Create a list of updated properties offending property immutability</span>
        <span class="n">update_replace_forbidden</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">changed_properties_set</span>
                                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">immutable_set</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">update_replace_forbidden</span><span class="p">:</span>
            <span class="n">mesg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Update to properties </span><span class="si">%(props)s</span><span class="s"> of </span><span class="si">%(name)s</span><span class="s"> (</span><span class="si">%(res)s</span><span class="s">)&quot;</span>
                     <span class="p">)</span> <span class="o">%</span> <span class="p">{</span><span class="s">&#39;props&#39;</span><span class="p">:</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">update_replace_forbidden</span><span class="p">)),</span>
                          <span class="s">&#39;res&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotSupported</span><span class="p">(</span><span class="n">feature</span><span class="o">=</span><span class="n">mesg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">changed_properties_set</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">update_allowed_set</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">after_props</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">changed_properties_set</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> &quot;</span><span class="si">%s</span><span class="s">&quot; [</span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                       <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encodeutils</span><span class="o">.</span><span class="n">safe_encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> &quot;</span><span class="si">%s</span><span class="s">&quot; [</span><span class="si">%s</span><span class="s">] </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">,</span>
                                            <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> &quot;</span><span class="si">%s</span><span class="s">&quot; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                       <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">encodeutils</span><span class="o">.</span><span class="n">safe_decode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.dep_attrs"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.dep_attrs">[docs]</a>    <span class="k">def</span> <span class="nf">dep_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">dep_attrs</span><span class="p">(</span><span class="n">resource_name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.add_dependencies"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.add_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">add_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">):</span>
            <span class="n">deps</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
        <span class="n">deps</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.required_by"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.required_by">[docs]</a>    <span class="k">def</span> <span class="nf">required_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Returns a list of names of resources which directly require this</span>
<span class="sd">        resource as a dependency.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span>
            <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">required_by</span><span class="p">(</span><span class="bp">self</span><span class="p">)])</span>
</div>
<div class="viewcode-block" id="Resource.client"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.client">[docs]</a>    <span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">client_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_client_name</span>
        <span class="k">assert</span> <span class="n">client_name</span><span class="p">,</span> <span class="s">&quot;Must specify client name&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.client_plugin"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.client_plugin">[docs]</a>    <span class="k">def</span> <span class="nf">client_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">client_name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_client_name</span>
        <span class="k">assert</span> <span class="n">client_name</span><span class="p">,</span> <span class="s">&quot;Must specify client name&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">client_plugin</span><span class="p">(</span><span class="n">client_name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.keystone"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.keystone">[docs]</a>    <span class="k">def</span> <span class="nf">keystone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;keystone&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.nova"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.nova">[docs]</a>    <span class="k">def</span> <span class="nf">nova</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;nova&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.swift"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.swift">[docs]</a>    <span class="k">def</span> <span class="nf">swift</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;swift&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.neutron"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.neutron">[docs]</a>    <span class="k">def</span> <span class="nf">neutron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;neutron&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.cinder"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.cinder">[docs]</a>    <span class="k">def</span> <span class="nf">cinder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;cinder&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.trove"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.trove">[docs]</a>    <span class="k">def</span> <span class="nf">trove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;trove&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.ceilometer"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.ceilometer">[docs]</a>    <span class="k">def</span> <span class="nf">ceilometer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;ceilometer&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.heat"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.heat">[docs]</a>    <span class="k">def</span> <span class="nf">heat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;heat&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.glance"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.glance">[docs]</a>    <span class="k">def</span> <span class="nf">glance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;glance&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@contextlib.contextmanager</span>
    <span class="k">def</span> <span class="nf">_action_recorder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">expected_exceptions</span><span class="o">=</span><span class="nb">tuple</span><span class="p">()):</span>
        <span class="sd">&#39;&#39;&#39;Return a context manager to record the progress of an action.</span>

<span class="sd">        Upon entering the context manager, the state is set to IN_PROGRESS.</span>
<span class="sd">        Upon exiting, the state will be set to COMPLETE if no exception was</span>
<span class="sd">        raised, or FAILED otherwise. Non-exit exceptions will be translated</span>
<span class="sd">        to ResourceFailure exceptions.</span>

<span class="sd">        Expected exceptions are re-raised, with the Resource left in the</span>
<span class="sd">        IN_PROGRESS state.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">)</span>
            <span class="k">yield</span>
        <span class="k">except</span> <span class="n">expected_exceptions</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">save_and_reraise_exception</span><span class="p">():</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%(action)s</span><span class="s">: </span><span class="si">%(info)s</span><span class="s">&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
                                              <span class="s">&quot;info&quot;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)},</span>
                     <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">failure</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">failure</span>
        <span class="k">except</span><span class="p">:</span>  <span class="c"># noqa</span>
            <span class="k">with</span> <span class="n">excutils</span><span class="o">.</span><span class="n">save_and_reraise_exception</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> aborted&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&#39;Error marking resource as failed&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.action_handler_task"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.action_handler_task">[docs]</a>    <span class="k">def</span> <span class="nf">action_handler_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[],</span> <span class="n">action_prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A task to call the Resource subclass&#39;s handler methods for an action.</span>

<span class="sd">        Calls the handle_&lt;ACTION&gt;() method for the given action and then calls</span>
<span class="sd">        the check_&lt;ACTION&gt;_complete() method with the result in a loop until it</span>
<span class="sd">        returns True. If the methods are not provided, the call is omitted.</span>

<span class="sd">        Any args provided are passed to the handler.</span>

<span class="sd">        If a prefix is supplied, the handler method handle_&lt;PREFIX&gt;_&lt;ACTION&gt;()</span>
<span class="sd">        is called instead.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">handler_action</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">check</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;check_</span><span class="si">%s</span><span class="s">_complete&#39;</span> <span class="o">%</span> <span class="n">handler_action</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">action_prefix</span><span class="p">:</span>
            <span class="n">handler_action</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action_prefix</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">handler_action</span><span class="p">)</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;handle_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">handler_action</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="n">handler_data</span> <span class="o">=</span> <span class="n">handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">yield</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">check</span><span class="p">):</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">check</span><span class="p">(</span><span class="n">handler_data</span><span class="p">):</span>
                    <span class="k">yield</span>
</div>
    <span class="nd">@scheduler.wrappertask</span>
    <span class="k">def</span> <span class="nf">_do_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">pre_func</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">resource_data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Perform a transition to a new state via a specified action</span>
<span class="sd">        action should be e.g self.CREATE, self.UPDATE etc, we set</span>
<span class="sd">        status based on this, the transition is handled by calling the</span>
<span class="sd">        corresponding handle_* and check_*_complete functions</span>
<span class="sd">        Note pre_func is an optional function reference which will</span>
<span class="sd">        be called before the handle_&lt;action&gt; function</span>

<span class="sd">        If the resource does not declare a check_$action_complete function,</span>
<span class="sd">        we declare COMPLETE status as soon as the handle_$action call has</span>
<span class="sd">        finished, and if no handle_$action function is declared, then we do</span>
<span class="sd">        nothing, useful e.g if the resource requires no action for a given</span>
<span class="sd">        state transition</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">assert</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIONS</span><span class="p">,</span> <span class="s">&#39;Invalid action </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">action</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_recorder</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">pre_func</span><span class="p">):</span>
                <span class="n">pre_func</span><span class="p">()</span>

            <span class="n">handler_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">resource_data</span><span class="p">]</span> <span class="k">if</span> <span class="n">resource_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[]</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_handler_task</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">handler_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_stored_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.preview"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.preview">[docs]</a>    <span class="k">def</span> <span class="nf">preview</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Default implementation of Resource.preview.</span>

<span class="sd">        This method should be overridden by child classes for specific</span>
<span class="sd">        behavior.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span>
</div>
    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Resource.create"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create the resource. Subclasses should provide a handle_create() method</span>
<span class="sd">        to customise creation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;State </span><span class="si">%s</span><span class="s"> invalid for create&#39;</span><span class="p">)</span>
                                  <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>

        <span class="c"># This method can be called when we replace a resource, too. In that</span>
        <span class="c"># case, a hook has already been dealt with in `Resource.update` so we</span>
        <span class="c"># shouldn&#39;t do it here again:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_break_if_required</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">HOOK_PRE_CREATE</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;creating </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="c"># Re-resolve the template, since if the resource Ref&#39;s</span>
        <span class="c"># the StackId pseudo parameter, it will change after</span>
        <span class="c"># the parser.Stack is stored (which is after the resources</span>
        <span class="c"># are __init__&#39;d, but before they are create()&#39;d)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reparse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_stored_properties</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">pause</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">yield</span>
            <span class="k">except</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="n">count</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="n">retry_limit</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CONF</span><span class="o">.</span><span class="n">action_retry_limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">first_failure</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">retry_limit</span> <span class="ow">and</span>
               <span class="n">count</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">retry_limit</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="n">action</span><span class="p">]:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">retry_backoff_delay</span><span class="p">(</span><span class="n">count</span><span class="p">[</span><span class="n">action</span><span class="p">],</span>
                                                      <span class="n">jitter_max</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
                <span class="n">waiter</span> <span class="o">=</span> <span class="n">scheduler</span><span class="o">.</span><span class="n">TaskRunner</span><span class="p">(</span><span class="n">pause</span><span class="p">)</span>
                <span class="n">waiter</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">delay</span><span class="p">)</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">waiter</span><span class="o">.</span><span class="n">step</span><span class="p">():</span>
                    <span class="k">yield</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_action</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">validate</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span> <span class="k">as</span> <span class="n">failure</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">failure</span><span class="o">.</span><span class="n">exc</span><span class="p">,</span> <span class="n">ResourceInError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">failure</span>

                <span class="n">count</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">:</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span>
                    <span class="n">count</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="n">first_failure</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c"># Save the first exception</span>
                    <span class="n">first_failure</span> <span class="o">=</span> <span class="n">failure</span>

        <span class="k">if</span> <span class="n">first_failure</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">first_failure</span>
</div>
<div class="viewcode-block" id="Resource.prepare_abandon"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.prepare_abandon">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_abandon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abandon_in_progress</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s">&#39;resource_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">,</span>
            <span class="s">&#39;type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">(),</span>
            <span class="s">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="s">&#39;metadata&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata_get</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
            <span class="s">&#39;resource_data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>
        <span class="p">}</span>
</div>
<div class="viewcode-block" id="Resource.adopt"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.adopt">[docs]</a>    <span class="k">def</span> <span class="nf">adopt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Adopt the existing resource. Resource subclasses can provide</span>
<span class="sd">        a handle_adopt() method to customise adopt.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_stored_properties</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADOPT</span><span class="p">,</span> <span class="n">resource_data</span><span class="o">=</span><span class="n">resource_data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.handle_adopt"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.handle_adopt">[docs]</a>    <span class="k">def</span> <span class="nf">handle_adopt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">resource_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_resource_info</span><span class="p">(</span><span class="n">resource_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource_id</span><span class="p">:</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Resource ID was not provided.&#39;</span><span class="p">))</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">failure</span>

        <span class="c"># set resource id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_id_set</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>

        <span class="c"># save the resource data</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data_set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c"># save the resource metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata_set</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_get_resource_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resource_data</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resource_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">resource_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resource_id&#39;</span><span class="p">),</span>
                <span class="n">resource_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;resource_data&#39;</span><span class="p">),</span>
                <span class="n">resource_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;metadata&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_needs_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span><span class="p">,</span>
                      <span class="n">prev_resource</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prev_resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cur_class_def</span><span class="p">,</span> <span class="n">cur_ver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">implementation_signature</span><span class="p">()</span>
            <span class="n">prev_class_def</span><span class="p">,</span> <span class="n">prev_ver</span> <span class="o">=</span> <span class="n">prev_resource</span><span class="o">.</span><span class="n">implementation_signature</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">prev_class_def</span> <span class="o">!=</span> <span class="n">cur_class_def</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prev_ver</span> <span class="o">!=</span> <span class="n">cur_ver</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">before</span> <span class="o">!=</span> <span class="n">after</span><span class="o">.</span><span class="n">freeze</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">before_props</span> <span class="o">!=</span> <span class="n">after_props</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Resource.update"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">prev_resource</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        update the resource. Subclasses should provide a handle_update() method</span>
<span class="sd">        to customise update, the base-class handle_update will fail by default.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">after</span><span class="p">,</span> <span class="n">rsrc_defn</span><span class="o">.</span><span class="n">ResourceDefinition</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">before</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frozen_definition</span><span class="p">()</span>

        <span class="n">before_props</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties_schema</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="n">after_props</span> <span class="o">=</span> <span class="n">after</span><span class="o">.</span><span class="n">properties</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties_schema</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">_break_if_required</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="n">environment</span><span class="o">.</span><span class="n">HOOK_PRE_UPDATE</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_needs_update</span><span class="p">(</span><span class="n">after</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after_props</span><span class="p">,</span> <span class="n">before_props</span><span class="p">,</span>
                                  <span class="n">prev_resource</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span> <span class="ow">in</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">CREATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">),</span>
                                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">),</span>
                                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ADOPT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IN_PROGRESS</span><span class="p">)):</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Resource update already requested&#39;</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;updating </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_recorder</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">UpdateReplace</span><span class="p">):</span>
            <span class="n">after_props</span><span class="o">.</span><span class="n">validate</span><span class="p">()</span>
            <span class="n">tmpl_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_template_diff</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">after</span><span class="p">),</span>
                                                  <span class="n">before</span><span class="p">)</span>
            <span class="n">prop_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_template_diff_properties</span><span class="p">(</span><span class="n">after_props</span><span class="p">,</span>
                                                             <span class="n">before_props</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_handler_task</span><span class="p">(</span><span class="n">action</span><span class="p">,</span>
                                           <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">after</span><span class="p">,</span> <span class="n">tmpl_diff</span><span class="p">,</span> <span class="n">prop_diff</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="n">after</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reparse</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_stored_properties</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Resource.check"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.check">[docs]</a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks that the physical resource is in its expected state</span>

<span class="sd">        Gets the current status of the physical resource and updates the</span>
<span class="sd">        database accordingly.  If check is not supported by the resource,</span>
<span class="sd">        default action is to fail and revert the resource&#39;s status to its</span>
<span class="sd">        original state with the added message that check was not performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CHECK</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Checking </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;handle_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">action</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reason</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> not supported for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_set</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_verify_check_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checks</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="n">check</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">check</span><span class="p">[</span><span class="s">&#39;expected&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">check</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">check</span><span class="p">[</span><span class="s">&#39;expected&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">check</span><span class="p">[</span><span class="s">&#39;current&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">check</span><span class="p">[</span><span class="s">&#39;expected&#39;</span><span class="p">]</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;&#39;</span><span class="si">%(attr)s</span><span class="s">&#39;: expected &#39;</span><span class="si">%(expected)s</span><span class="s">&#39;, got &#39;</span><span class="si">%(current)s</span><span class="s">&#39;&quot;</span><span class="p">)</span>
        <span class="n">invalid_checks</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">msg</span> <span class="o">%</span> <span class="n">check</span>
            <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">checks</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">(</span><span class="n">check</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">invalid_checks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">invalid_checks</span><span class="p">))</span>

<div class="viewcode-block" id="Resource.suspend"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.suspend">[docs]</a>    <span class="k">def</span> <span class="nf">suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Suspend the resource.  Subclasses should provide a handle_suspend()</span>
<span class="sd">        method to implement suspend</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUSPEND</span>

        <span class="c"># Don&#39;t try to suspend the resource unless it&#39;s in a stable state</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;State </span><span class="si">%s</span><span class="s"> invalid for suspend&#39;</span><span class="p">)</span>
                                  <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;suspending </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.resume"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.resume">[docs]</a>    <span class="k">def</span> <span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Resume the resource.  Subclasses should provide a handle_resume()</span>
<span class="sd">        method to implement resume</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RESUME</span>

        <span class="c"># Can&#39;t resume a resource unless it&#39;s SUSPEND_COMPLETE</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUSPEND</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;State </span><span class="si">%s</span><span class="s"> invalid for resume&#39;</span><span class="p">)</span>
                                  <span class="o">%</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;resuming </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.snapshot"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Snapshot the resource and return the created data, if any.&#39;&#39;&#39;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;snapshotting </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_do_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SNAPSHOT</span><span class="p">)</span>
</div>
    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Resource.delete_snapshot"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.delete_snapshot">[docs]</a>    <span class="k">def</span> <span class="nf">delete_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_handler_task</span><span class="p">(</span><span class="s">&#39;delete_snapshot&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">data</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="Resource.physical_resource_name"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.physical_resource_name">[docs]</a>    <span class="k">def</span> <span class="nf">physical_resource_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                             <span class="n">short_id</span><span class="o">.</span><span class="n">get_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">physical_resource_name_limit</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduce_physical_resource_name</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">physical_resource_name_limit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Resource.reduce_physical_resource_name"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.reduce_physical_resource_name">[docs]</a>    <span class="k">def</span> <span class="nf">reduce_physical_resource_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">limit</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Reduce length of physical resource name to a limit.</span>

<span class="sd">        The reduced name will consist of the following:</span>

<span class="sd">        * the first 2 characters of the name</span>
<span class="sd">        * a hyphen</span>
<span class="sd">        * the end of the name, truncated on the left to bring</span>
<span class="sd">          the name length within the limit</span>

<span class="sd">        :param name: The name to reduce the length of</span>
<span class="sd">        :param limit: The max length limit</span>
<span class="sd">        :returns: A name whose length is less than or equal to the limit</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">name</span>

        <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;limit cannot be less than 4&#39;</span><span class="p">))</span>

        <span class="n">postfix_length</span> <span class="o">=</span> <span class="n">limit</span> <span class="o">-</span> <span class="mi">3</span>
        <span class="k">return</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;-&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="n">postfix_length</span><span class="p">:]</span>
</div>
<div class="viewcode-block" id="Resource.validate"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.validate">[docs]</a>    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Validating </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="n">function</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_deletion_policy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">deletion_policy</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">validate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span>
                <span class="n">with_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">strict_validate</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">get_section_name</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">path</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span>
                <span class="n">error</span><span class="o">=</span><span class="n">ex</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">ex</span><span class="o">.</span><span class="n">error_message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">validate</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Resource.validate_deletion_policy"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.validate_deletion_policy">[docs]</a>    <span class="k">def</span> <span class="nf">validate_deletion_policy</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">policy</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">policy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rsrc_defn</span><span class="o">.</span><span class="n">ResourceDefinition</span><span class="o">.</span><span class="n">DELETION_POLICIES</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Invalid deletion policy &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">policy</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">policy</span> <span class="o">==</span> <span class="n">rsrc_defn</span><span class="o">.</span><span class="n">ResourceDefinition</span><span class="o">.</span><span class="n">SNAPSHOT</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s">&#39;handle_snapshot_delete&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; deletion policy not supported&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">policy</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">StackValidationFailed</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
</div>
    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Resource.delete"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Delete the resource. Subclasses should provide a handle_delete() method</span>
<span class="sd">        to customise deletion.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="c"># No need to delete if the resource has never been created</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">initial_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;deleting </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_recorder</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abandon_in_progress</span><span class="p">:</span>
                <span class="n">deletion_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">RETAIN</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deletion_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">deletion_policy</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">deletion_policy</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">RETAIN</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">deletion_policy</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">SNAPSHOT</span><span class="p">:</span>
                    <span class="n">action_args</span> <span class="o">=</span> <span class="p">[[</span><span class="n">initial_state</span><span class="p">],</span> <span class="s">&#39;snapshot&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">action_args</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_handler_task</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="o">*</span><span class="n">action_args</span><span class="p">)</span>
</div>
    <span class="nd">@scheduler.wrappertask</span>
<div class="viewcode-block" id="Resource.destroy"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.destroy">[docs]</a>    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Delete the resource and remove it from the database.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="c"># Don&#39;t fail on delete if the db entry has</span>
            <span class="c"># not been created yet.</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Resource.resource_id_set"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.resource_id_set">[docs]</a>    <span class="k">def</span> <span class="nf">resource_id_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="o">=</span> <span class="n">inst</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rs</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">rs</span><span class="o">.</span><span class="n">update_and_save</span><span class="p">({</span><span class="s">&#39;nova_instance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s">&#39;db error </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create the resource in the database.&#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
                  <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                  <span class="s">&#39;status_reason&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span><span class="p">,</span>
                  <span class="s">&#39;stack_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                  <span class="s">&#39;nova_instance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">,</span>
                  <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                  <span class="s">&#39;rsrc_metadata&#39;</span><span class="p">:</span> <span class="n">metadata</span><span class="p">,</span>
                  <span class="s">&#39;properties_data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span><span class="p">,</span>
                  <span class="s">&#39;needed_by&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">needed_by</span><span class="p">,</span>
                  <span class="s">&#39;requires&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires</span><span class="p">,</span>
                  <span class="s">&#39;replaces&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaces</span><span class="p">,</span>
                  <span class="s">&#39;replaced_by&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaced_by</span><span class="p">,</span>
                  <span class="s">&#39;current_template_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_template_id</span><span class="p">,</span>
                  <span class="s">&#39;stack_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>

            <span class="n">new_rs</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">rs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">new_rs</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uuid</span> <span class="o">=</span> <span class="n">new_rs</span><span class="o">.</span><span class="n">uuid</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="n">new_rs</span><span class="o">.</span><span class="n">created_at</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&#39;DB error </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add a state change event to the database.&#39;&#39;&#39;</span>
        <span class="n">ev</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">())</span>

        <span class="n">ev</span><span class="o">.</span><span class="n">store</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_store_or_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="n">prev_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_reason</span> <span class="o">=</span> <span class="n">reason</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;action&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span>
            <span class="s">&#39;status&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
            <span class="s">&#39;status_reason&#39;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
            <span class="s">&#39;stack_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s">&#39;updated_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">updated_time</span><span class="p">,</span>
            <span class="s">&#39;properties_data&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stored_properties_data</span><span class="p">,</span>
            <span class="s">&#39;needed_by&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">needed_by</span><span class="p">,</span>
            <span class="s">&#39;requires&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requires</span><span class="p">,</span>
            <span class="s">&#39;replaces&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaces</span><span class="p">,</span>
            <span class="s">&#39;replaced_by&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">replaced_by</span><span class="p">,</span>
            <span class="s">&#39;current_template_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_template_id</span><span class="p">,</span>
            <span class="s">&#39;nova_instance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">prev_action</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">metadata</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;rsrc_metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rs</span> <span class="o">=</span> <span class="n">resource_objects</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="n">get_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">rs</span><span class="o">.</span><span class="n">update_and_save</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&#39;DB error </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="n">ex</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rsrc_metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># This should only happen in unit tests</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s">&#39;Resource &quot;</span><span class="si">%s</span><span class="s">&quot; not pre-stored in DB&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resolve_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Default implementation; should be overridden by resources that expose</span>
<span class="sd">        attributes</span>

<span class="sd">        :param name: The attribute to resolve</span>
<span class="sd">        :returns: the resource attribute named key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># By default, no attributes resolve</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Resource.state_reset"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.state_reset">[docs]</a>    <span class="k">def</span> <span class="nf">state_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset state to (INIT, COMPLETE)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INIT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">COMPLETE</span>
</div>
<div class="viewcode-block" id="Resource.state_set"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.state_set">[docs]</a>    <span class="k">def</span> <span class="nf">state_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s">&quot;state changed&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ACTIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Invalid action </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">action</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUSES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Invalid status </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">status</span><span class="p">)</span>

        <span class="n">old_state</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="n">new_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store_or_update</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_state</span> <span class="o">!=</span> <span class="n">old_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">reset_resource_attributes</span><span class="p">()</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns state, tuple of action, status.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>

<div class="viewcode-block" id="Resource.FnGetRefId"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.FnGetRefId">[docs]</a>    <span class="k">def</span> <span class="nf">FnGetRefId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        For the intrinsic function Ref.</span>

<span class="sd">        :results: the id or name of the resource.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">has_cache_data</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">cache_data_resource_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.physical_resource_name_or_FnGetRefId"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.physical_resource_name_or_FnGetRefId">[docs]</a>    <span class="k">def</span> <span class="nf">physical_resource_name_or_FnGetRefId</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">physical_resource_name</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">res_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="n">res_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Resource</span><span class="o">.</span><span class="n">FnGetRefId</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.FnGetAtt"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.FnGetAtt">[docs]</a>    <span class="k">def</span> <span class="nf">FnGetAtt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        For the intrinsic function Fn::GetAtt.</span>

<span class="sd">        :param key: the attribute key.</span>
<span class="sd">        :param path: a list of path components to select from the attribute.</span>
<span class="sd">        :returns: the attribute value.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">has_cache_data</span><span class="p">():</span>
            <span class="c"># Load from cache for lightweight resources.</span>
            <span class="n">attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">cache_data_resource_attribute</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">attribute</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">InvalidTemplateAttribute</span><span class="p">(</span><span class="n">resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                         <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">attributes</span><span class="o">.</span><span class="n">select_from_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.FnBase64"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.FnBase64">[docs]</a>    <span class="k">def</span> <span class="nf">FnBase64</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        For the instrinsic function Fn::Base64.</span>

<span class="sd">        :param data: the input data.</span>
<span class="sd">        :returns: the Base64 representation of the input data.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.signal"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.signal">[docs]</a>    <span class="k">def</span> <span class="nf">signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        signal the resource. Subclasses should provide a handle_signal() method</span>
<span class="sd">        to implement the signal, the base-class raise an exception if no</span>
<span class="sd">        handler is implemented.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SUSPEND</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DELETE</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                            <span class="s">&#39;Cannot signal resource during </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">)</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#39;Cannot signal resource during </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_string_details</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">details</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;No signal details provided&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">details</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">details</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;previous&#39;</span><span class="p">,</span> <span class="s">&#39;current&#39;</span><span class="p">,</span>
                                              <span class="s">&#39;reason&#39;</span><span class="p">)):</span>
                    <span class="c"># this is from Ceilometer.</span>
                    <span class="n">auto</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%(previous)s</span><span class="s"> to </span><span class="si">%(current)s</span><span class="s"> (</span><span class="si">%(reason)s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">details</span>
                    <span class="k">return</span> <span class="s">&#39;alarm state changed from </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">auto</span>
                <span class="k">elif</span> <span class="s">&#39;state&#39;</span> <span class="ow">in</span> <span class="n">details</span><span class="p">:</span>
                    <span class="c"># this is from watchrule</span>
                    <span class="k">return</span> <span class="s">&#39;alarm state changed to </span><span class="si">%(state)s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">details</span>

            <span class="k">return</span> <span class="s">&#39;Unknown&#39;</span>

        <span class="c"># Clear the hook without interfering with resources&#39;</span>
        <span class="c"># `handle_signal` callbacks:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">details</span> <span class="ow">and</span> <span class="s">&#39;unset_hook&#39;</span> <span class="ow">in</span> <span class="n">details</span> <span class="ow">and</span>
                <span class="n">environment</span><span class="o">.</span><span class="n">valid_hook_type</span><span class="p">(</span><span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;unset_hook&#39;</span><span class="p">))):</span>
            <span class="n">hook</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="s">&#39;unset_hook&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">clear_hook</span><span class="p">(</span><span class="n">hook</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_LI</span><span class="p">(</span><span class="s">&#39;Clearing </span><span class="si">%(hook)s</span><span class="s"> hook on </span><span class="si">%(resource)s</span><span class="s">&#39;</span><span class="p">),</span>
                         <span class="p">{</span><span class="s">&#39;hook&#39;</span><span class="p">:</span> <span class="n">hook</span><span class="p">,</span> <span class="s">&#39;resource&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)})</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span>
                                <span class="s">&quot;Hook </span><span class="si">%s</span><span class="s"> is cleared&quot;</span> <span class="o">%</span> <span class="n">hook</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;handle_signal&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceActionNotSupported</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s">&#39;signal&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">signal_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_signal</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">signal_result</span><span class="p">:</span>
                <span class="n">reason_string</span> <span class="o">=</span> <span class="s">&quot;Signal: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">signal_result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reason_string</span> <span class="o">=</span> <span class="n">get_string_details</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_event</span><span class="p">(</span><span class="s">&#39;SIGNAL&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">reason_string</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">NoActionRequired</span><span class="p">:</span>
            <span class="c"># Don&#39;t log an event as it just spams the user.</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">_LE</span><span class="p">(</span><span class="s">&#39;signal </span><span class="si">%(name)s</span><span class="s"> : </span><span class="si">%(msg)s</span><span class="s">&#39;</span><span class="p">)</span>
                          <span class="o">%</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">six</span><span class="o">.</span><span class="n">text_type</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="s">&#39;msg&#39;</span><span class="p">:</span> <span class="n">ex</span><span class="p">})</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">exception</span><span class="o">.</span><span class="n">ResourceFailure</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">failure</span>
</div>
<div class="viewcode-block" id="Resource.handle_update"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.handle_update">[docs]</a>    <span class="k">def</span> <span class="nf">handle_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_snippet</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tmpl_diff</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">prop_diff</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prop_diff</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UpdateReplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Resource.metadata_update"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.metadata_update">[docs]</a>    <span class="k">def</span> <span class="nf">metadata_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_metadata</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        No-op for resources which don&#39;t explicitly override this method</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">new_metadata</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_LW</span><span class="p">(</span><span class="s">&quot;Resource </span><span class="si">%s</span><span class="s"> does not implement metadata update&quot;</span><span class="p">),</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</div>
    <span class="nd">@classmethod</span>
<div class="viewcode-block" id="Resource.resource_to_template"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.resource_to_template">[docs]</a>    <span class="k">def</span> <span class="nf">resource_to_template</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">,</span> <span class="n">template_type</span><span class="o">=</span><span class="s">&#39;cfn&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        :param resource_type: The resource type to be displayed in the template</span>
<span class="sd">        :param template_type: the template type to generate, cfn or hot.</span>
<span class="sd">        :returns: A template where the resource&#39;s properties_schema is mapped</span>
<span class="sd">            as parameters, and the resource&#39;s attributes_schema is mapped as</span>
<span class="sd">            outputs</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">properties_schema</span>
        <span class="n">params</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">Properties</span><span class="o">.</span>
                         <span class="n">schema_to_parameters_and_properties</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span>
                                                             <span class="n">template_type</span><span class="p">))</span>
        <span class="n">resource_name</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">Attributes</span><span class="o">.</span><span class="n">as_outputs</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span>
                                                   <span class="n">template_type</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="s">&#39;Initial template of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">resource_name</span>
        <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">build_template_dict</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="n">resource_type</span><span class="p">,</span>
                                       <span class="n">template_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span>
                                       <span class="n">outputs</span><span class="p">,</span> <span class="n">description</span><span class="p">)</span>
</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Resource.build_template_dict"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.build_template_dict">[docs]</a>    <span class="k">def</span> <span class="nf">build_template_dict</span><span class="p">(</span><span class="n">res_name</span><span class="p">,</span> <span class="n">res_type</span><span class="p">,</span> <span class="n">tmpl_type</span><span class="p">,</span>
                            <span class="n">params</span><span class="p">,</span> <span class="n">props</span><span class="p">,</span> <span class="n">outputs</span><span class="p">,</span> <span class="n">description</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tmpl_type</span> <span class="o">==</span> <span class="s">&#39;hot&#39;</span><span class="p">:</span>
            <span class="n">tmpl_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">HOTemplate20150430</span><span class="o">.</span><span class="n">VERSION</span><span class="p">:</span> <span class="s">&#39;2015-04-30&#39;</span><span class="p">,</span>
                <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">HOTemplate20150430</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">HOTemplate20150430</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
                <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">HOTemplate20150430</span><span class="o">.</span><span class="n">OUTPUTS</span><span class="p">:</span> <span class="n">outputs</span><span class="p">,</span>
                <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">HOTemplate20150430</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">res_name</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">RES_TYPE</span><span class="p">:</span> <span class="n">res_type</span><span class="p">,</span>
                        <span class="n">hot_tmpl</span><span class="o">.</span><span class="n">RES_PROPERTIES</span><span class="p">:</span> <span class="n">props</span><span class="p">}}}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmpl_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">CfnTemplate</span><span class="o">.</span><span class="n">ALTERNATE_VERSION</span><span class="p">:</span> <span class="s">&#39;2012-12-12&#39;</span><span class="p">,</span>
                <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">CfnTemplate</span><span class="o">.</span><span class="n">DESCRIPTION</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">CfnTemplate</span><span class="o">.</span><span class="n">PARAMETERS</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
                <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">CfnTemplate</span><span class="o">.</span><span class="n">RESOURCES</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">res_name</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">RES_TYPE</span><span class="p">:</span> <span class="n">res_type</span><span class="p">,</span>
                        <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">RES_PROPERTIES</span><span class="p">:</span> <span class="n">props</span><span class="p">}</span>
                <span class="p">},</span>
                <span class="n">cfn_tmpl</span><span class="o">.</span><span class="n">CfnTemplate</span><span class="o">.</span><span class="n">OUTPUTS</span><span class="p">:</span> <span class="n">outputs</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">tmpl_dict</span>
</div>
<div class="viewcode-block" id="Resource.data"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.data">[docs]</a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Resource data for this resource</span>

<span class="sd">        Use methods data_set and data_delete to modify the resource data</span>
<span class="sd">        for this resource.</span>

<span class="sd">        :returns: a dict representing the resource data for this resource.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">resource_data_objects</span><span class="o">.</span><span class="n">ResourceData</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="ow">or</span> <span class="p">{}</span>
</div>
<div class="viewcode-block" id="Resource.data_set"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.data_set">[docs]</a>    <span class="k">def</span> <span class="nf">data_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">redact</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Save resource&#39;s key/value pair to database.&#39;&#39;&#39;</span>
        <span class="n">resource_data_objects</span><span class="o">.</span><span class="n">ResourceData</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">redact</span><span class="p">)</span>
        <span class="c"># force fetch all resource data from the database again</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Resource.data_delete"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.data_delete">[docs]</a>    <span class="k">def</span> <span class="nf">data_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Remove a resource_data element associated to a resource.</span>

<span class="sd">        :returns: True if the key existed to delete</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">resource_data_objects</span><span class="o">.</span><span class="n">ResourceData</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">exception</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># force fetch all resource data from the database again</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Resource.is_using_neutron"><a class="viewcode-back" href="../../../sourcecode/heat/heat.engine.resource.html#heat.engine.resource.Resource.is_using_neutron">[docs]</a>    <span class="k">def</span> <span class="nf">is_using_neutron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s">&#39;neutron&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="../../../raxdox/index.html">Supported Resources</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2012,2015 Heat Developers.
      Last updated on Wed May 20 12:03:06 2015, commit 58910c6.
    </div>
  </body>
</html>